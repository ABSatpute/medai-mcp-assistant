<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MedAI - Medical Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* CSS Variables for Consistency */
        :root {
            --primary-blue: #2563eb;
            --primary-blue-hover: #1d4ed8;
            --gray-light: #f8fafc;
            --gray-border: #e2e8f0;
            --gray-text: #64748b;
            --gray-dark: #374151;
            --border-radius: 8px;
            --padding-btn: 12px 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            background: white;
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: var(--gray-light);
            border-right: 1px solid var(--gray-border);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            margin-left: -300px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .expand-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }

        .chat-header {
            padding: 20px 30px 20px 70px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .sidebar-toggle:hover {
            background: var(--primary-blue-hover);
            transform: scale(1.05);
        }

        .app-container.sidebar-collapsed .sidebar-toggle {
            left: 20px;
        }

        .sidebar {
            background: var(--gray-light);
            border-right: 1px solid var(--gray-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .app-container.sidebar-collapsed .sidebar {
            width: 0;
            min-width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid var(--gray-border);
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .logo i {
            margin-right: 10px;
        }

        .tagline {
            color: var(--gray-text);
            font-size: 14px;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 12px 20px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            background: var(--primary-blue-hover);
            transform: translateY(-2px);
        }

        .chat-threads {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-sessions-heading {
            margin: 20px 20px 15px;
            color: var(--gray-dark);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-border);
        }

        .thread-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            border: 1px solid transparent;
        }

        .thread-item:hover {
            background: var(--gray-light);
            border-color: var(--gray-border);
        }

        .thread-item.active {
            background: #dbeafe;
            border-color: var(--primary-blue);
        }

        .thread-title {
            flex: 1;
            font-size: 14px;
            color: var(--gray-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .thread-delete {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
            border-radius: 6px;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .thread-delete:hover {
            background: #fee2e2;
            transform: scale(1.1);
            opacity: 1;
        }

        .thread-delete i {
            font-size: 12px;
        }

        .thread-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--gray-border);
            position: relative;
            overflow: hidden;
        }

        .thread-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-blue), #3b82f6);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .thread-item:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: var(--primary-blue);
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }

        .thread-item:hover::before {
            transform: scaleY(1);
        }

        .thread-item.active {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: var(--primary-blue);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.25);
            transform: translateX(6px);
        }

        .thread-item.active::before {
            transform: scaleY(1);
            background: linear-gradient(180deg, #1d4ed8, var(--primary-blue));
        }

        .thread-title {
            flex: 1;
            font-size: 14px;
            color: var(--gray-dark);
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .thread-item.active .thread-title {
            color: var(--primary-blue);
            font-weight: 700;
        }

        .thread-delete-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            cursor: pointer;
            padding: 10px;
            margin-left: 12px;
            border-radius: 10px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.8;
            transform: scale(1);
            position: relative;
            overflow: hidden;
        }

        .thread-delete-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .thread-item:hover .thread-delete-btn {
            opacity: 1;
            transform: scale(1.05);
        }

        .thread-delete-btn:hover {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #ef4444;
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
            color: #dc2626;
        }

        .thread-delete-btn:hover::before {
            left: 100%;
        }

        .thread-delete-btn:active {
            transform: scale(0.95) rotate(-2deg);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6);
        }

        .thread-delete-btn i {
            font-size: 12px;
            transition: all 0.3s;
        }

        .thread-delete-btn:hover i {
            transform: scale(1.2);
            filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
        }

        /* Loading Spinner Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading pulse effect */
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Typing dots animation */
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-blue);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Streaming cursor animation */
        .streaming-cursor {
            color: var(--primary-blue);
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .streaming-content {
            position: relative;
        }

        .threads-container {
            padding: 0 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px 30px 20px 70px !important;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-container.sidebar-collapsed .chat-header {
            padding: 20px 30px !important;
        }

        .chat-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .chat-header .sidebar-toggle {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 15px;
        }

        .chat-header .sidebar-toggle:hover {
            background: #1d4ed8;
        }
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            padding: 20px 30px 120px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
        }

        .app-container.sidebar-collapsed .messages-container {
            transition: all 0.3s ease;
            padding: 20px 30px 120px 30px;
        }

        .welcome-section {
            text-align: center;
            margin: auto;
            max-width: 600px;
            padding: 0 20px;
        }

        .app-container.sidebar-collapsed .welcome-section {
            max-width: 800px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            color: #64748b;
            font-size: 18px;
            margin-bottom: 40px;
        }

        .action-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-card {
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border: none;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .action-card i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }

        .action-card h3 {
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .action-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
            gap: 15px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #2563eb;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #10b981;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: #f1f5f9;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
        }

        .app-container.sidebar-collapsed .message-content {
            max-width: 60%;
        }

        .message.user .message-content {
            background: #2563eb;
            color: white;
        }

        /* Message content formatting */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 10px 0 5px 0;
            font-weight: 600;
        }

        .message-content h1 { font-size: 18px; }
        .message-content h2 { font-size: 16px; }
        .message-content h3 { font-size: 14px; }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
            list-style-type: disc;
        }

        .message-content strong {
            font-weight: 600;
            color: inherit;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }

        .medicine-highlight {
            background: linear-gradient(120deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .message.user .medicine-highlight {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .dosage-highlight {
            background: linear-gradient(120deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            color: #0369a1;
            border: 1px solid #0ea5e9;
        }

        .message.user .dosage-highlight {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .message-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .input-area {
            position: fixed;
            bottom: 0;
            left: 300px;
            right: 0;
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .app-container.sidebar-collapsed .input-area {
            left: 0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .message-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }

        .upload-btn {
            width: 50px;
            height: 50px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #475569;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            background: var(--gray-light);
            color: var(--gray-dark);
            border: 2px solid var(--gray-border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .voice-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .sidebar {
                display: none;
            }

            .sidebar-toggle {
                display: block;
            }

            .action-cards {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 24px;
            }

            .messages-container {
                padding: 20px;
            }

            .input-area {
                padding: 15px 20px;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    MedAI
                </div>
                <div class="tagline">Medical Assistant with MCP</div>
            </div>
            
            <button class="new-chat-btn" onclick="newChat()">
                <i class="fas fa-plus"></i> New Chat
            </button>
            
            <div class="chat-threads" id="chatThreads">
                <h3 class="chat-sessions-heading">üí¨ Chat Sessions</h3>
                <div id="threadsList" style="padding: 0 20px;">
                    <!-- Threads will be loaded here -->
                </div>
            </div>

        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <h1 class="chat-title" id="chatTitle">Medical Assistant</h1>
            </div>

            <div class="chat-area">
                <div class="messages-container" id="chatMessages">
                    <!-- Welcome Section -->
                    <div class="welcome-section" id="welcomeSection">
                        <h2 class="welcome-title">Welcome to MedAI</h2>
                        <p class="welcome-subtitle">Your intelligent medical assistant for medicines and healthcare</p>
                        
                        <div class="action-cards">
                            <button class="action-card" onclick="showMedicineSearch()">
                                <i class="fas fa-pills"></i>
                                <h3>Find Medicines</h3>
                                <p>Search for medicines and check availability</p>
                            </button>
                            
                            <button class="action-card" onclick="showStoreLocator()">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>Store Locator</h3>
                                <p>Find nearest pharmacies and medical stores</p>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-camera"></i>
                        </button>
                        
                        <input 
                            type="text" 
                            id="messageInput" 
                            class="message-input"
                            placeholder="Ask about medicines, stores, or health..."
                            onkeypress="handleKeyPress(event)"
                        >
                        
                        <button class="voice-btn" onclick="toggleVoiceInput()" id="voiceBtn">
                            <i class="fas fa-microphone" id="voiceIcon"></i>
                        </button>
                        
                        <button class="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Voice input functionality
        let recognition = null;
        let isListening = false;
        let silenceTimer = null;

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    console.log('üé§ Voice recognition started');
                    isListening = true;
                    updateVoiceButton();
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Show live transcription in input field
                    const input = document.getElementById('messageInput');
                    input.value = finalTranscript + interimTranscript;
                    
                    // Auto-send after 2 seconds of silence if we have final text
                    if (finalTranscript.trim()) {
                        clearTimeout(silenceTimer);
                        silenceTimer = setTimeout(() => {
                            if (finalTranscript.trim()) {
                                stopVoiceInput();
                                sendMessage();
                            }
                        }, 2000);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('üé§ Voice recognition error:', event.error);
                    stopVoiceInput();
                };
                
                recognition.onend = function() {
                    console.log('üé§ Voice recognition ended');
                    isListening = false;
                    updateVoiceButton();
                };
                
                return true;
            }
            return false;
        }

        function toggleVoiceInput() {
            if (!recognition) {
                if (!initVoiceRecognition()) {
                    alert('Voice input is not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }
            }
            
            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            const input = document.getElementById('messageInput');
            input.value = '';
            input.placeholder = 'Listening... Speak now';
            
            recognition.start();
        }

        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
            }
            clearTimeout(silenceTimer);
            
            const input = document.getElementById('messageInput');
            input.placeholder = 'Ask about medicines, stores, or health...';
        }

        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceIcon = document.getElementById('voiceIcon');
            
            if (isListening) {
                voiceBtn.classList.add('listening');
                voiceIcon.className = 'fas fa-stop';
                voiceBtn.title = 'Stop listening';
            } else {
                voiceBtn.classList.remove('listening');
                voiceIcon.className = 'fas fa-microphone';
                voiceBtn.title = 'Start voice input';
            }
        }

        // Text-to-Speech functionality
        let speechSynthesis = window.speechSynthesis;
        let currentSpeech = null;

        function speakText(text) {
            // Stop any current speech
            if (currentSpeech) {
                speechSynthesis.cancel();
            }

            // Clean text for better speech (remove markdown, special chars)
            const cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markdown
                .replace(/\*(.*?)\*/g, '$1')     // Remove italic markdown
                .replace(/`(.*?)`/g, '$1')       // Remove code markdown
                .replace(/#{1,6}\s/g, '')        // Remove headers
                .replace(/[üìçüè•üíäüîç‚ö°]/g, '')      // Remove emojis
                .trim();

            if (cleanText && 'speechSynthesis' in window) {
                currentSpeech = new SpeechSynthesisUtterance(cleanText);
                
                // Configure voice settings
                currentSpeech.rate = 0.9;        // Slightly slower for clarity
                currentSpeech.pitch = 1.0;       // Normal pitch
                currentSpeech.volume = 0.8;      // Slightly quieter
                
                // Try to use a more natural voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.name.includes('Microsoft') ||
                    voice.lang.startsWith('en')
                );
                if (preferredVoice) {
                    currentSpeech.voice = preferredVoice;
                }

                currentSpeech.onstart = function() {
                    console.log('üîä Started speaking AI response');
                };

                currentSpeech.onend = function() {
                    console.log('üîä Finished speaking AI response');
                    currentSpeech = null;
                };

                currentSpeech.onerror = function(event) {
                    console.error('üîä Speech synthesis error:', event.error);
                    currentSpeech = null;
                };

                // Start speaking
                speechSynthesis.speak(currentSpeech);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                currentSpeech = null;
            }
        }

        // Production-ready sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            const appContainer = document.querySelector('.app-container');
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                appContainer.classList.remove('sidebar-collapsed');
                expandBtn.style.display = 'none';
                localStorage.setItem('sidebarCollapsed', 'false');
            } else {
                sidebar.classList.add('collapsed');
                appContainer.classList.add('sidebar-collapsed');
                expandBtn.style.display = 'block';
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        // Initialize sidebar state
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            const appContainer = document.querySelector('.app-container');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                appContainer.classList.add('sidebar-collapsed');
                expandBtn.style.display = 'block';
            }
        }
        
        // Show medicine search popup
        function showMedicineSearch() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            `;
            
            popup.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1e293b;">üíä Find Medicines</h2>
                        <button onclick="document.body.removeChild(this.closest('.popup'))" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">‚úï</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Search by Medicine Name:</label>
                        <input type="text" id="medicineNameInput" placeholder="Enter medicine names (e.g., dolo, crocin, paracetamol)..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <span style="color: #64748b; font-weight: 600;">OR</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Upload Prescription:</label>
                        <input type="file" id="prescriptionUpload" accept="image/*" style="display: none;" onchange="handlePrescriptionUpload(event)">
                        <button onclick="document.getElementById('prescriptionUpload').click()" style="width: 100%; padding: 15px; border: 2px dashed #2563eb; background: #f8fafc; color: #2563eb; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            üì∑ Upload Prescription Image
                        </button>
                    </div>
                    
                    <div id="extractedMedicines" style="display: none; margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Extracted Medicines:</label>
                        <div id="medicinesList" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; background: #f8fafc;"></div>
                    </div>
                    
                    <button onclick="searchMedicines()" style="width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üîç Search Medicines
                    </button>
                    
                    <div id="searchResults" style="margin-top: 20px;"></div>
                </div>
            `;
            
            popup.className = 'popup';
            document.body.appendChild(popup);
        }
        
        // Handle prescription upload
        function handlePrescriptionUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Show loading
                    document.getElementById('extractedMedicines').style.display = 'block';
                    document.getElementById('medicinesList').innerHTML = '<div style="text-align: center; color: #64748b;">üîç Analyzing prescription...</div>';
                    
                    // Send to backend for analysis
                    socket.emit('analyze_prescription', {
                        image: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Search medicines function
        function searchMedicines() {
            const medicineNameInput = document.getElementById('medicineNameInput').value.trim();
            const extractedMeds = document.querySelectorAll('.medicine-item input:checked');
            
            let medicines = [];
            
            // Split comma-separated medicine names
            if (medicineNameInput) {
                const splitMedicines = medicineNameInput.split(',').map(name => name.trim()).filter(name => name.length > 0);
                medicines.push(...splitMedicines);
            }
            
            // Add extracted medicines from prescription
            extractedMeds.forEach(med => medicines.push(med.value));
            
            if (medicines.length === 0) {
                alert('Please enter medicine name(s) or upload prescription');
                return;
            }
            
            // Disable search button during loading
            const searchButton = document.querySelector('button[onclick="searchMedicines()"]');
            if (searchButton) {
                searchButton.disabled = true;
                searchButton.style.opacity = '0.6';
                searchButton.style.cursor = 'not-allowed';
                searchButton.innerHTML = '‚è≥ Searching...';
            }
            
            // Debug: Show what we're searching for
            console.log('üîç Searching for medicines:', medicines);
            console.log('üîç Total medicines to search:', medicines.length);
            
            // Show beautiful loading animation
            document.getElementById('searchResults').innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--primary-blue);">
                    <div style="display: inline-block; position: relative;">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 15px; font-weight: 600; font-size: 16px;">
                            üîç Searching Medicines...
                        </div>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--gray-text);">
                            Finding best stores and availability
                        </div>
                    </div>
                </div>
            `;
            
            // Send search request with user location
            socket.emit('search_medicines', {
                medicines: medicines,
                location: userLocation || {latitude: 18.566039, longitude: 73.766370}
            });
            
            // Debug: Confirm request sent
            console.log('üì° Search request sent to backend with medicines:', medicines);
            console.log('üì° User location:', userLocation);
        }
        
        // Store Locator popup functions
        function showStoreLocator() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    showStorePopup(lat, lon);
                }, (error) => {
                    alert('Please enable location access to find nearby stores');
                });
            } else {
                alert('Geolocation not supported by this browser');
            }
        }
        
        function showStorePopup(lat, lon) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            `;
            popup.id = 'storePopup';
            
            popup.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1e293b;">üó∫Ô∏è Store Locator</h2>
                        <button onclick="closeStorePopup()" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">‚úï</button>
                    </div>
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 10px 0; height: 300px;">
                        <div id="mapContainer" style="height: 100%; background: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                            üó∫Ô∏è Loading map...
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Load Folium map from backend
            setTimeout(() => {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <iframe src="/api/map/${lat}/${lon}" style="width: 100%; height: 100%; border: none; border-radius: 4px;"></iframe>
                    `;
                }
            }, 100);
        }
        
        function closeStorePopup() {
            const popup = document.getElementById('storePopup');
            if (popup) {
                document.body.removeChild(popup);
            }
        }

        // Chat session management
        let currentThreadId = null;
        let userLocation = null;

        // Load chat threads from API
        function loadChatThreads() {
            fetch('/api/threads')
                .then(response => {
                    if (!response.ok) throw new Error('API not available');
                    return response.json();
                })
                .then(threads => {
                    const threadsList = document.getElementById('threadsList');
                    if (!threadsList) return;
                    
                    threadsList.innerHTML = '';
                    
                    if (threads.length === 0) {
                        threadsList.innerHTML = '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">No previous chats</div>';
                        return;
                    }
                    
                    threads.forEach(thread => {
                        const threadDiv = document.createElement('div');
                        threadDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;';
                        
                        const isCurrent = thread.id === currentThreadId;
                        if (isCurrent) {
                            threadDiv.style.background = '#dbeafe';
                        }
                        
                        threadDiv.innerHTML = `
                            <div style="flex: 1; font-size: 13px; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${isCurrent ? 'üü¢ ' : ''}${thread.title}
                            </div>
                            <button onclick="deleteThread('${thread.id}', event)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px; margin-left: 8px;">
                                <i class="fas fa-trash" style="font-size: 10px;"></i>
                            </button>
                        `;
                        
                        threadDiv.onclick = (e) => {
                            if (e.target.closest('button')) return;
                            loadThread(thread.id);
                        };
                        
                        threadDiv.onmouseenter = () => {
                            if (!isCurrent) threadDiv.style.background = '#f3f4f6';
                        };
                        threadDiv.onmouseleave = () => {
                            if (!isCurrent) threadDiv.style.background = 'transparent';
                        };
                        
                        threadsList.appendChild(threadDiv);
                    });
                })
                .catch(error => {
                    console.log('Chat threads not available:', error);
                    const threadsList = document.getElementById('threadsList');
                    if (threadsList) {
                        threadsList.innerHTML = '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">Chat history unavailable</div>';
                    }
                });
        }

        // Load specific thread (simplified)
        function loadThread(threadId) {
            console.log('Loading thread:', threadId);
            currentThreadId = threadId;
            
            // Clear current messages
            document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">Loading chat...</div>';
            
            // Hide welcome section
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // Try to load messages from API
            fetch(`/api/thread/${threadId}/messages`)
                .then(response => {
                    if (!response.ok) throw new Error('Thread not found');
                    return response.json();
                })
                .then(messages => {
                    // Clear loading message
                    document.getElementById('chatMessages').innerHTML = '';
                    
                    // Add messages
                    messages.forEach(msg => {
                        addMessageToChat(msg.role, msg.content);
                    });
                    
                    // Update thread list to show current
                    loadChatThreads();
                })
                .catch(error => {
                    console.log('Could not load thread messages:', error);
                    // Show error but don't break
                    document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Could not load chat history</div>';
                });
        }

        // Delete thread
        function deleteThread(threadId, event) {
            event.stopPropagation();
            if (confirm('Delete this chat?')) {
                fetch(`/api/thread/${threadId}/delete`, { method: 'DELETE' })
                    .then(() => {
                        if (threadId === currentThreadId) {
                            newChat();
                        }
                        loadChatThreads();
                    })
                    .catch(error => console.error('Error deleting thread:', error));
            }
        }

        // New chat function (simplified)
        function newChat() {
            // Generate new thread ID
            currentThreadId = 'thread_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Clear all messages first
            document.getElementById('chatMessages').innerHTML = '';
            
            // Create fresh welcome section with action buttons
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-section" id="welcomeSection">
                    <h2 class="welcome-title">Welcome to MedAI</h2>
                    <p class="welcome-subtitle">Your intelligent medical assistant for medicines and healthcare</p>
                    
                    <div class="action-cards">
                        <button class="action-card" onclick="showMedicineSearch()">
                            <i class="fas fa-pills"></i>
                            <h3>Find Medicines</h3>
                            <p>Search for medicines and check availability</p>
                        </button>
                        
                        <button class="action-card" onclick="showStoreLocator()">
                            <i class="fas fa-map-marker-alt"></i>
                            <h3>Store Locator</h3>
                            <p>Find nearest pharmacies and medical stores</p>
                        </button>
                    </div>
                </div>
            `;
            
            // Update title
            document.getElementById('chatTitle').textContent = 'Medical Assistant';
            
            // Add new thread to sidebar immediately
            addNewThreadToSidebar(currentThreadId, 'New Chat');
            
            console.log('New chat started:', currentThreadId);
        }

        // Add new thread to sidebar
        function addNewThreadToSidebar(threadId, title) {
            const threadsList = document.getElementById('threadsList');
            if (!threadsList) return;
            
            // Remove active class from all existing threads
            const existingThreads = threadsList.querySelectorAll('.thread-item');
            existingThreads.forEach(thread => {
                thread.classList.remove('active');
                const titleDiv = thread.querySelector('.thread-title');
                if (titleDiv && titleDiv.textContent.startsWith('üü¢ ')) {
                    titleDiv.textContent = titleDiv.textContent.replace('üü¢ ', '');
                }
            });
            
            // Create new thread element with CSS classes
            const threadDiv = document.createElement('div');
            threadDiv.className = 'thread-item active';
            
            threadDiv.innerHTML = `
                <div class="thread-title">üü¢ ${title}</div>
                <button class="thread-delete-btn" onclick="deleteThread('${threadId}', event)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            threadDiv.onclick = (e) => {
                if (e.target.closest('button')) return;
                loadThread(threadId);
            };
            
            // Add to top of list
            threadsList.insertBefore(threadDiv, threadsList.firstChild);
        }

        // Load chat threads with new styling
        function loadChatThreads() {
            fetch('/api/threads')
                .then(response => response.json())
                .then(threads => {
                    const threadsList = document.getElementById('threadsList');
                    if (!threadsList) return;
                    
                    // Clear existing threads
                    threadsList.innerHTML = '';
                    
                    // Add each thread with new styling
                    threads.forEach(thread => {
                        const threadDiv = document.createElement('div');
                        threadDiv.className = 'thread-item';
                        
                        threadDiv.innerHTML = `
                            <div class="thread-title">${thread.title}</div>
                            <button class="thread-delete-btn" onclick="deleteThread('${thread.id}', event)">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        
                        threadDiv.onclick = (e) => {
                            if (e.target.closest('button')) return;
                            loadThread(thread.id);
                        };
                        
                        threadsList.appendChild(threadDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading threads:', error);
                    const threadsList = document.getElementById('threadsList');
                    if (threadsList) {
                        threadsList.innerHTML = '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">Chat history unavailable</div>';
                    }
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSidebar();
            loadChatThreads(); // Load existing threads with new styling
            newChat(); // Start with a new chat
            // Enable thread loading with error handling
            try {
                loadChatThreads();
            } catch (error) {
                console.log('Thread loading failed, continuing without it');
            }
        });

        // Initialize socket connection
        const socket = io();
        currentThreadId = 'main-thread-' + Date.now();
        
        socket.on('connect', () => {
            console.log('‚úÖ Socket connected');
        });
        
        socket.on('message_received', (data) => {
            console.log('üì® Message received:', data);
            
            addMessageToChat(data.role, data.content);
            
            // Auto-play text-to-speech for AI responses
            if (data.role === 'assistant') {
                speakText(data.content);
            }
            
            // Add AI thinking loader after user message appears
            if (data.role === 'user') {
                addAIThinkingLoader();
            }
            
            // Remove AI thinking loader when assistant responds
            if (data.role === 'assistant') {
                removeAIThinkingLoader();
            }
            
            // Refresh sidebar after assistant response to show new/updated threads
            if (data.role === 'assistant') {
                setTimeout(() => {
                    try {
                        loadChatThreads();
                    } catch (error) {
                        console.log('Could not refresh threads');
                    }
                }, 1000);
            }
        });

        // Handle streaming response events
        let currentStreamingMessage = null;
        let streamingContent = '';
        let accumulatedText = '';
        let lastSpokenLength = 0;

        socket.on('response_start', (data) => {
            console.log('üîÑ Streaming response started');
            removeAIThinkingLoader();
            
            // Stop any current speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // Reset speech tracking
            accumulatedText = '';
            lastSpokenLength = 0;
            
            // Create empty assistant message for streaming
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = `streaming-${data.thread_id}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content streaming-content">
                    <span class="streaming-cursor">|</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            currentStreamingMessage = messageDiv.querySelector('.message-content');
            streamingContent = '';
        });

        socket.on('response_chunk', (data) => {
            if (currentStreamingMessage) {
                streamingContent += data.chunk;
                const formattedContent = formatMessageContent(streamingContent);
                currentStreamingMessage.innerHTML = formattedContent + '<span class="streaming-cursor">|</span>';
                
                // Accumulate text for natural speech
                accumulatedText += data.chunk;
                
                // Speak when we have a complete sentence or phrase
                speakAccumulatedText();
                
                // Auto-scroll
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });

        socket.on('response_complete', (data) => {
            console.log('‚úÖ Streaming response completed');
            
            if (currentStreamingMessage) {
                // Remove cursor and finalize content
                const formattedContent = formatMessageContent(data.full_content);
                currentStreamingMessage.innerHTML = formattedContent;
                currentStreamingMessage.classList.remove('streaming-content');
                
                // Speak any remaining text
                speakRemainingText();
                
                // Reset streaming state
                currentStreamingMessage = null;
                streamingContent = '';
                accumulatedText = '';
                lastSpokenLength = 0;
            }
        });

        function speakAccumulatedText() {
            // Clean text for speech
            const cleanText = accumulatedText.replace(/<[^>]*>/g, '').trim();
            
            // Find natural break points (sentences, commas, etc.)
            const sentences = cleanText.match(/[^.!?]*[.!?]+/g) || [];
            
            // If we have complete sentences, speak them
            if (sentences.length > 0) {
                const textToSpeak = sentences.join(' ').trim();
                const newTextToSpeak = textToSpeak.substring(lastSpokenLength);
                
                if (newTextToSpeak.trim() && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(newTextToSpeak);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    
                    // Use natural voice
                    const voices = speechSynthesis.getVoices();
                    const preferredVoice = voices.find(voice => 
                        voice.name.includes('Google') || 
                        voice.name.includes('Microsoft') ||
                        voice.lang.startsWith('en')
                    );
                    if (preferredVoice) {
                        utterance.voice = preferredVoice;
                    }
                    
                    speechSynthesis.speak(utterance);
                    lastSpokenLength = textToSpeak.length;
                }
            }
        }

        function speakRemainingText() {
            // Speak any remaining text that wasn't spoken
            const cleanText = accumulatedText.replace(/<[^>]*>/g, '').trim();
            const remainingText = cleanText.substring(lastSpokenLength).trim();
            
            if (remainingText && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(remainingText);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.name.includes('Microsoft') ||
                    voice.lang.startsWith('en')
                );
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        socket.on('title_updated', (data) => {
            console.log('üìù Title updated:', data);
            // Update chat title in header
            if (data.thread_id === currentThreadId) {
                document.getElementById('chatTitle').textContent = data.title;
            }
            // Refresh sidebar to show updated title
            try {
                loadChatThreads();
            } catch (error) {
                console.log('Could not refresh threads');
            }
        });
        
        socket.on('show_map', (data) => {
            console.log('üó∫Ô∏è Map data received:', data);
            
            // If waiting for popup map, update the popup
            if (window.waitingForPopupMap && data.stores) {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="width: 100%; height: 100%; background: #059669; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex-direction: column;">
                            <div>üìç Found ${data.stores.length} stores</div>
                            <div style="font-size: 12px; margin-top: 5px;">Map will be enhanced next</div>
                        </div>
                    `;
                }
                window.waitingForPopupMap = false;
            }
        });
        
        socket.on('medicine_search_result', (data) => {
            console.log('üíä Medicine search result received:', data);
            
            // Re-enable search button
            const searchButton = document.querySelector('button[onclick="searchMedicines()"]');
            if (searchButton) {
                searchButton.disabled = false;
                searchButton.style.opacity = '1';
                searchButton.style.cursor = 'pointer';
                searchButton.innerHTML = 'üîç Search Medicines';
            }
            
            const resultsDiv = document.getElementById('searchResults');
            if (!resultsDiv) return;
            
            if (data.error) {
                resultsDiv.innerHTML = `<div style="color: red; padding: 20px;">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            if (data.success && data.results) {
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 20px; color: #64748b;">No medicines found</div>';
                } else {
                    let html = '<div style="padding: 20px;">';
                    
                    // Add search summary if available
                    if (data.search_summary) {
                        html += `<div style="background: #f0f9ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <strong>üîç Search Summary:</strong><br>
                            Searched for: ${data.search_summary.medicines_requested.join(', ')}<br>`;
                        
                        // Show LLM spelling corrections if any
                        if (data.search_summary.spelling_corrections && Object.keys(data.search_summary.spelling_corrections).length > 0) {
                            html += `<div style="background: #fef3c7; padding: 8px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #f59e0b;">
                                <strong>ü§ñ Smart Corrections:</strong><br>`;
                            for (const [original, corrected] of Object.entries(data.search_summary.spelling_corrections)) {
                                html += `‚Ä¢ "${original}" ‚Üí "${corrected}"<br>`;
                            }
                            html += `</div>`;
                        }
                        
                        html += `Found ${data.search_summary.total_stores_found} stores<br>
                            Best match: ${data.search_summary.best_match}
                        </div>`;
                    }
                    
                    html += '<h4>üè™ Stores (Ranked by Availability):</h4>';
                    
                    data.results.forEach((store, index) => {
                        // Handle both old format (array) and new format (object)
                        if (Array.isArray(store)) {
                            // Old format compatibility
                            html += `
                                <div style="border: 1px solid #e5e7eb; padding: 15px; margin: 10px 0; border-radius: 8px;">
                                    <strong>${store[0] || 'Unknown Medicine'}</strong><br>
                                    Price: ‚Çπ${store[1] || 'N/A'}<br>
                                    Store: ${store[2] || 'Unknown Store'}<br>
                                    Stock: ${store[3] || 'N/A'} units
                                </div>
                            `;
                        } else {
                            // New enhanced format
                            const availabilityColor = store.availability_percentage >= 80 ? '#10b981' : 
                                                    store.availability_percentage >= 50 ? '#f59e0b' : '#ef4444';
                            
                            html += `
                                <div style="border: 1px solid #e5e7eb; padding: 15px; margin: 10px 0; border-radius: 8px; background: ${index === 0 ? '#f0f9ff' : 'white'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h5 style="margin: 0; color: #1f2937;">${store.store_name}</h5>
                                        <span style="background: ${availabilityColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                            ${store.availability_percentage}% Match
                                        </span>
                                    </div>
                                    
                                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">
                                        üìç ${store.distance} km away ‚Ä¢ 
                                        üì¶ ${store.medicines_available}/${store.total_medicines_requested} medicines available
                                    </div>
                                    
                                    <div style="background: #f9fafb; padding: 10px; border-radius: 6px;">
                                        <strong>Available Medicines:</strong><br>
                            `;
                            
                            store.medicines.forEach(medicine => {
                                html += `
                                    <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 4px;">
                                        ‚Ä¢ <strong>${medicine.name}</strong> - ‚Çπ${medicine.price} 
                                        <span style="color: #10b981;">(${medicine.stock} in stock)</span>
                                    </div>
                                `;
                            });
                            
                            html += `
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                }
            }
        });
        
        socket.on('prescription_analysis_result', (data) => {
            console.log('üìã Prescription analysis result received:', data);
            console.log('üìã Data structure:', JSON.stringify(data, null, 2));
            console.log('üìã Medicines found:', data.data ? data.data.medicines : 'No data.medicines');
            
            const extractedSection = document.getElementById('extractedMedicines');
            const medicinesList = document.getElementById('medicinesList');
            
            if (!extractedSection || !medicinesList) {
                console.log('üìã ERROR: Could not find extractedMedicines or medicinesList elements');
                return;
            }
            
            if (data.error) {
                medicinesList.innerHTML = `<div style="color: red;">‚ùå Error: ${data.error}</div>`;
                extractedSection.style.display = 'block';
                return;
            }
            
            if (data.success && data.data) {
                const medicines = data.data.medicines || [];
                console.log('üìã Processing medicines array:', medicines);
                
                if (medicines.length === 0) {
                    medicinesList.innerHTML = '<div style="color: #64748b;">No medicines detected in image</div>';
                } else {
                    let html = '<div>Found medicines:</div>';
                    medicines.forEach((medicine, index) => {
                        html += `
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" class="medicine-item" value="${medicine}" checked style="margin-right: 8px;">
                                ${medicine}
                            </label>
                        `;
                    });
                    medicinesList.innerHTML = html;
                }
                
                extractedSection.style.display = 'block';
                console.log('üìã Extracted medicines section should now be visible');
            }
        });
        
        // Add AI thinking loader
        function addAIThinkingLoader() {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'ai-thinking-loader';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content" style="background: var(--gray-light); color: var(--gray-text);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span style="font-style: italic;">AI is thinking...</span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Remove AI thinking loader
        function removeAIThinkingLoader() {
            const loader = document.getElementById('ai-thinking-loader');
            if (loader) {
                loader.remove();
            }
        }

        // Add message to chat interface
        function addMessageToChat(role, content) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Hide welcome section when first message is added
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = role === 'user' ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
            
            // Format content for better display
            const formattedContent = formatMessageContent(content);
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${formattedContent}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessageContent(content) {
            // Convert markdown-like formatting to HTML
            let formatted = content
                // Bold text: **text** -> <strong>text</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text: *text* -> <em>text</em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code: `text` -> <code>text</code>
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks: \n -> <br>
                .replace(/\n/g, '<br>')
                // Headers: ### text -> <h3>text</h3>
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // Lists: - item -> <li>item</li>
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                // Wrap consecutive <li> items in <ul>
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                // Fix nested ul tags
                .replace(/<\/ul>\s*<ul>/g, '');

            return formatted;
        }
        
        // Send quick message from action cards
        function sendQuickMessage(message) {
            console.log('üéØ Sending message:', message);
            
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = message;
            }
            
            socket.emit('send_message', {
                thread_id: currentThreadId,
                message: message,
                location: null
            });
        }
        
        // Handle manual message input
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log('Sending message with thread ID:', currentThreadId);
            
            socket.emit('send_message', {
                thread_id: currentThreadId,
                message: message,
                location: null
            });
            
            input.value = '';
            
            // Hide welcome section
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
        }
        
        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    socket.emit('send_message', {
                        thread_id: currentThreadId,
                        message: '',
                        image: e.target.result,
                        location: null
                    });
                };
                reader.readAsDataURL(file);
            }
        }
        
        // End of JavaScript
    </script>
</body>
</html>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
