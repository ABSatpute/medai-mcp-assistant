<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MedAI - Medical Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* CSS Variables for Consistency */
        :root {
            --primary-blue: #2563eb;
            --primary-blue-hover: #1d4ed8;
            --gray-light: #f8fafc;
            --gray-border: #e2e8f0;
            --gray-text: #64748b;
            --gray-dark: #374151;
            --border-radius: 8px;
            --padding-btn: 12px 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            background: white;
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 300px;
            background: var(--gray-light);
            border-right: 1px solid var(--gray-border);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            margin-left: -300px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .expand-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }

        .chat-header {
            padding: 20px 30px 20px 70px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .sidebar-toggle:hover {
            background: var(--primary-blue-hover);
            transform: scale(1.05);
        }

        .app-container.sidebar-collapsed .sidebar-toggle {
            left: 20px;
        }

        .sidebar {
            background: var(--gray-light);
            border-right: 1px solid var(--gray-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .app-container.sidebar-collapsed .sidebar {
            width: 0;
            min-width: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid var(--gray-border);
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .logo i {
            margin-right: 10px;
        }

        .tagline {
            color: var(--gray-text);
            font-size: 14px;
        }

        .new-chat-btn {
            margin: 20px;
            padding: 12px 20px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            background: var(--primary-blue-hover);
            transform: translateY(-2px);
        }

        .chat-threads {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-sessions-heading {
            margin: 20px 20px 15px;
            color: var(--gray-dark);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-border);
        }

        .thread-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            border: 1px solid transparent;
        }

        .thread-item:hover {
            background: var(--gray-light);
            border-color: var(--gray-border);
        }

        .thread-item.active {
            background: #dbeafe;
            border-color: var(--primary-blue);
        }

        .thread-title {
            flex: 1;
            font-size: 14px;
            color: var(--gray-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .thread-delete {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
            border-radius: 6px;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .thread-delete:hover {
            background: #fee2e2;
            transform: scale(1.1);
            opacity: 1;
        }

        .thread-delete i {
            font-size: 12px;
        }

        .thread-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid var(--gray-border);
            position: relative;
            overflow: hidden;
        }

        .thread-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-blue), #3b82f6);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .thread-item:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: var(--primary-blue);
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }

        .thread-item:hover::before {
            transform: scaleY(1);
        }

        .thread-item.active {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: var(--primary-blue);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.25);
            transform: translateX(6px);
        }

        .thread-item.active::before {
            transform: scaleY(1);
            background: linear-gradient(180deg, #1d4ed8, var(--primary-blue));
        }

        .thread-title {
            flex: 1;
            font-size: 14px;
            color: var(--gray-dark);
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        .thread-item.active .thread-title {
            color: var(--primary-blue);
            font-weight: 700;
        }

        .thread-delete-btn {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
            cursor: pointer;
            padding: 10px;
            margin-left: 12px;
            border-radius: 10px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.8;
            transform: scale(1);
            position: relative;
            overflow: hidden;
        }

        .thread-delete-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .thread-item:hover .thread-delete-btn {
            opacity: 1;
            transform: scale(1.05);
        }

        .thread-delete-btn:hover {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: #ef4444;
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
            color: #dc2626;
        }

        .thread-delete-btn:hover::before {
            left: 100%;
        }

        .thread-delete-btn:active {
            transform: scale(0.95) rotate(-2deg);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.6);
        }

        .thread-delete-btn i {
            font-size: 12px;
            transition: all 0.3s;
        }

        .thread-delete-btn:hover i {
            transform: scale(1.2);
            filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
        }

        /* Loading Spinner Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading pulse effect */
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 2px solid rgba(37, 99, 235, 0.2);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Typing dots animation */
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-blue);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Streaming cursor animation */
        .streaming-cursor {
            color: var(--primary-blue);
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .streaming-content {
            position: relative;
        }

        .threads-container {
            padding: 0 20px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px 30px 20px 70px !important;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-container.sidebar-collapsed .chat-header {
            padding: 20px 30px !important;
        }

        .chat-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .chat-header .sidebar-toggle {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 15px;
        }

        .chat-header .sidebar-toggle:hover {
            background: #1d4ed8;
        }
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            padding: 20px 30px 120px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 200px);
        }

        .app-container.sidebar-collapsed .messages-container {
            transition: all 0.3s ease;
            padding: 20px 30px 120px 30px;
        }

        .welcome-section {
            text-align: center;
            margin: auto;
            max-width: 600px;
            padding: 0 20px;
        }

        .app-container.sidebar-collapsed .welcome-section {
            max-width: 800px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            color: #64748b;
            font-size: 18px;
            margin-bottom: 40px;
        }

        .action-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-card {
            padding: 30px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border: none;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .action-card i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }

        .action-card h3 {
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .action-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-start;
            gap: 15px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #2563eb;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #10b981;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: #f1f5f9;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
        }

        .app-container.sidebar-collapsed .message-content {
            max-width: 60%;
        }

        .message.user .message-content {
            background: #2563eb;
            color: white;
        }

        /* Message content formatting */
        .message-content h1, .message-content h2, .message-content h3 {
            margin: 10px 0 5px 0;
            font-weight: 600;
        }

        .message-content h1 { font-size: 18px; }
        .message-content h2 { font-size: 16px; }
        .message-content h3 { font-size: 14px; }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
            list-style-type: disc;
        }

        .message-content strong {
            font-weight: 600;
            color: inherit;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }

        .medicine-highlight {
            background: linear-gradient(120deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .message.user .medicine-highlight {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .dosage-highlight {
            background: linear-gradient(120deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            color: #0369a1;
            border: 1px solid #0ea5e9;
        }

        .message.user .dosage-highlight {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .message-time {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .input-area {
            position: fixed;
            bottom: 0;
            left: 300px;
            right: 0;
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .app-container.sidebar-collapsed .input-area {
            left: 0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .message-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }

        .upload-btn {
            width: 50px;
            height: 50px;
            background: #64748b;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #475569;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            background: var(--gray-light);
            color: var(--gray-dark);
            border: 2px solid var(--gray-border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .voice-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .sidebar {
                display: none;
            }

            .sidebar-toggle {
                display: block;
            }

            .action-cards {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 24px;
            }

            .messages-container {
                padding: 20px;
            }

            .input-area {
                padding: 15px 20px;
            }
        }

        .hidden {
            display: none !important;
        }

        .auth-form.hidden {
            display: none !important;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-btn, .cart-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            background: white;
            color: var(--gray-dark);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .user-btn:hover, .cart-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .user-btn.logged-in {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .cart-btn {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .cart-btn:hover {
            background: #059669;
            border-color: #059669;
            color: white;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-border);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gray-dark);
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--gray-text);
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--gray-dark);
        }

        .modal-body {
            padding: 24px;
        }

        /* Auth Form Styles */
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--gray-border);
        }

        .auth-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            color: var(--gray-text);
        }

        .auth-tab.active {
            background: var(--primary-blue);
            color: white;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-form input {
            padding: 12px 16px;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-btn {
            padding: 12px 20px;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .auth-btn:hover {
            background: var(--primary-blue-hover);
        }

        /* User Profile Styles */
        .profile-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--gray-light);
            border-radius: 8px;
        }

        .profile-avatar {
            font-size: 48px;
            color: var(--primary-blue);
        }

        .profile-details h4 {
            margin: 0 0 4px 0;
            color: var(--gray-dark);
            font-size: 16px;
        }

        .profile-details p {
            margin: 0;
            color: var(--gray-text);
            font-size: 14px;
        }

        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-btn {
            padding: 12px 16px;
            background: white;
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            color: var(--gray-dark);
        }

        .profile-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .logout-btn {
            padding: 12px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-stethoscope"></i>
                    MedAI
                </div>
                <div class="tagline">Medical Assistant with MCP</div>
            </div>
            
            <button class="new-chat-btn" onclick="newChat()">
                <i class="fas fa-plus"></i> New Chat
            </button>
            
            <div class="chat-threads" id="chatThreads">
                <h3 class="chat-sessions-heading">ðŸ’¬ Chat Sessions</h3>
                <div id="threadsList" style="padding: 0 20px;">
                    <!-- Threads will be loaded here -->
                </div>
            </div>

        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <h1 class="chat-title" id="chatTitle">Medical Assistant</h1>
                <div class="header-actions">
                    <button class="cart-btn" id="cartBtn" onclick="toggleCart()" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cartCount">0</span>
                    </button>
                    <button class="user-btn" id="userBtn" onclick="toggleUserModal()">
                        <i class="fas fa-user"></i>
                        <span id="userBtnText">Login</span>
                    </button>
                </div>
            </div>

            <div class="chat-area">
                <div class="messages-container" id="chatMessages">
                    <!-- Welcome Section -->
                    <div class="welcome-section" id="welcomeSection">
                        <h2 class="welcome-title">Welcome to MedAI</h2>
                        <p class="welcome-subtitle">Your intelligent medical assistant for medicines and healthcare</p>
                        
                        <div class="action-cards">
                            <button class="action-card" onclick="showMedicineSearch()">
                                <i class="fas fa-pills"></i>
                                <h3>Find Medicines</h3>
                                <p>Search for medicines and check availability</p>
                            </button>
                            
                            <button class="action-card" onclick="showStoreLocator()">
                                <i class="fas fa-map-marker-alt"></i>
                                <h3>Store Locator</h3>
                                <p>Find nearest pharmacies and medical stores</p>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <!-- Hidden dummy inputs to confuse autofill -->
                        <input type="text" style="display:none">
                        <input type="password" style="display:none">
                        
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-camera"></i>
                        </button>
                        
                        <input 
                            type="text" 
                            id="messageInput" 
                            class="message-input"
                            placeholder="Ask about medicines, stores, or health..."
                            onkeypress="handleKeyPress(event)"
                            autocomplete="new-password"
                            autocorrect="off"
                            autocapitalize="off"
                            spellcheck="false"
                            name="message-input-unique"
                            data-form-type="other"
                        >
                        
                        <button class="voice-btn" onclick="toggleVoiceInput()" id="voiceBtn">
                            <i class="fas fa-microphone" id="voiceIcon"></i>
                        </button>
                        
                        <button class="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication State
        let currentUser = null;
        let authToken = localStorage.getItem('medai_token');

        // Initialize authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                verifyToken();
            }
        });

        // Modal Functions
        function toggleUserModal() {
            const modal = document.getElementById('userModal');
            if (currentUser) {
                // Show user profile
                showUserProfile();
            } else {
                // Show login form
                showAuthForms();
            }
            modal.classList.add('show');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }

        function showAuthTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide both forms first
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            
            // Show only the selected form
            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
            } else if (tab === 'register') {
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        function showAuthForms() {
            // Hide user profile
            document.getElementById('userProfile').classList.add('hidden');
            
            // Show login form, hide register form
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            
            document.getElementById('modalTitle').textContent = 'Welcome to MedAI';
            
            // Reset active tab to login
            document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.auth-tab').classList.add('active');
        }

        function showUserProfile() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('userProfile').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = 'My Account';
            
            if (currentUser) {
                document.getElementById('profileName').textContent = currentUser.full_name || 'User';
                document.getElementById('profileEmail').textContent = currentUser.email;
            }
        }

        // Authentication Functions
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('medai_token', authToken);
                    updateUserButton();
                    clearAuthForms();
                    closeUserModal();
                    alert('Login successful!');
                    loadCartCount();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }

        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const full_name = document.getElementById('registerName').value;
            const phone = document.getElementById('registerPhone').value;
            
            if (!email || !password || !full_name) {
                alert('Please fill in required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, full_name, phone })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    localStorage.setItem('medai_token', authToken);
                    updateUserButton();
                    clearAuthForms();
                    closeUserModal();
                    alert('Registration successful!');
                    loadCartCount();
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (error) {
                alert('Registration error: ' + error.message);
            }
        }

        async function verifyToken() {
            try {
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateUserButton();
                    loadCartCount();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function updateUserButton() {
            const userBtn = document.getElementById('userBtn');
            const userBtnText = document.getElementById('userBtnText');
            const cartBtn = document.getElementById('cartBtn');
            
            if (currentUser) {
                userBtn.classList.add('logged-in');
                userBtnText.textContent = currentUser.full_name || 'User';
                cartBtn.style.display = 'flex';
            } else {
                userBtn.classList.remove('logged-in');
                userBtnText.textContent = 'Login';
                cartBtn.style.display = 'none';
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('medai_token');
            updateUserButton();
            clearAuthForms();
            document.getElementById('cartCount').textContent = '0';
            closeUserModal();
        }

        function clearAuthForms() {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPhone').value = '';
            document.getElementById('registerPassword').value = '';
        }

        async function loadCartCount() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/cart', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('cartCount').textContent = data.item_count || 0;
                }
            } catch (error) {
                console.error('Error loading cart count:', error);
            }
        }

        async function toggleCart() {
            if (!authToken) {
                alert('Please login to view cart');
                return;
            }
            
            console.log('ðŸ›’ Loading cart...');
            
            try {
                const response = await fetch('/api/cart', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('ðŸ›’ Cart response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ðŸ›’ Cart data:', data);
                    showCartModal(data);
                } else {
                    const errorData = await response.json();
                    console.error('ðŸ›’ Cart error:', errorData);
                    alert('Error loading cart: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('ðŸ›’ Cart fetch error:', error);
                alert('Error loading cart: ' + error.message);
            }
        }
        
        function showCartModal(cartData) {
            const modal = document.createElement('div');
            modal.id = 'cartModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; justify-content: center; align-items: center;
            `;
            
            // Close modal when clicking outside
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeCartModal();
                }
            };
            
            let itemsHtml = '';
            if (cartData.items && cartData.items.length > 0) {
                cartData.items.forEach(item => {
                    itemsHtml += `
                        <div style="border: 1px solid #e5e7eb; padding: 12px; margin: 8px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.medicine_name}</strong><br>
                                <small>${item.store_name}</small><br>
                                <span>â‚¹${item.unit_price} Ã— ${item.quantity} = â‚¹${item.total_price}</span>
                            </div>
                            <button onclick="removeFromCart(${item.item_id})" style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
            } else {
                itemsHtml = '<div style="text-align: center; color: #64748b; padding: 20px;">Your cart is empty</div>';
            }
            
            modal.innerHTML = `
                <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">ðŸ›’ My Cart</h3>
                        <button onclick="closeCartModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #64748b;">âœ•</button>
                    </div>
                    <div style="padding: 20px;">
                        ${itemsHtml}
                        ${cartData.items && cartData.items.length > 0 ? `
                            <div style="border-top: 2px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold;">
                                    <span>Total: â‚¹${cartData.total_amount || 0}</span>
                                    <button onclick="startCheckout()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        Proceed to Checkout
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeCartModal() {
            const modal = document.getElementById('cartModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Checkout Functions
        async function startCheckout() {
            if (!authToken) {
                alert('Please login to checkout');
                return;
            }
            
            // Close cart modal first
            closeCartModal();
            
            // Get cart data
            try {
                const response = await fetch('/api/cart', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const cartData = await response.json();
                    if (cartData.items && cartData.items.length > 0) {
                        showCheckoutModal(cartData);
                    } else {
                        alert('Your cart is empty');
                    }
                } else {
                    alert('Error loading cart for checkout');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function showCheckoutModal(cartData) {
            const modal = document.createElement('div');
            modal.id = 'checkoutModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 10001;
                display: flex; justify-content: center; align-items: center;
                overflow-y: auto; padding: 20px;
            `;
            
            // Close modal when clicking outside
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeCheckoutModal();
                }
            };
            
            let itemsHtml = '';
            cartData.items.forEach(item => {
                itemsHtml += `
                    <div style="border: 1px solid #e5e7eb; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; background: #f9fafb;">
                        <div>
                            <strong>${item.medicine_name}</strong><br>
                            <small style="color: #64748b;">${item.store_name}</small>
                        </div>
                        <div style="text-align: right;">
                            <div>â‚¹${item.unit_price} Ã— ${item.quantity}</div>
                            <div style="font-weight: bold;">â‚¹${item.total_price}</div>
                        </div>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">ðŸ›’ Checkout</h3>
                        <button onclick="closeCheckoutModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #64748b;">âœ•</button>
                    </div>
                    
                    <div style="padding: 20px;">
                        <!-- Order Summary -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #1f2937;">ðŸ“¦ Order Summary</h4>
                            ${itemsHtml}
                            <div style="border-top: 2px solid #e5e7eb; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                                <span>Total:</span>
                                <span>â‚¹${cartData.total_amount || 0}</span>
                            </div>
                        </div>
                        
                        <!-- Delivery Address -->
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin: 0 0 15px 0; color: #1f2937;">ðŸ  Delivery Address</h4>
                            <form id="addressForm" style="display: grid; gap: 12px;">
                                <input type="text" id="fullName" placeholder="Full Name *" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <input type="tel" id="phone" placeholder="Phone Number *" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <textarea id="streetAddress" placeholder="Street Address *" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; min-height: 60px;"></textarea>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <input type="text" id="city" placeholder="City *" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <input type="text" id="state" placeholder="State *" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <input type="text" id="postalCode" placeholder="Postal Code *" required style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <input type="text" id="landmark" placeholder="Landmark (optional)" style="padding: 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>
                            </form>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeCheckoutModal()" style="padding: 12px 24px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="proceedToPayment()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Proceed to Payment
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Pre-fill user data if available
            if (currentUser) {
                document.getElementById('fullName').value = currentUser.full_name || '';
                document.getElementById('phone').value = currentUser.phone || '';
            }
        }
        
        function closeCheckoutModal() {
            const modal = document.getElementById('checkoutModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        async function proceedToPayment() {
            // Validate address form
            const form = document.getElementById('addressForm');
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#ef4444';
                    isValid = false;
                } else {
                    field.style.borderColor = '#d1d5db';
                }
            });
            
            if (!isValid) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Collect address data
            const addressData = {
                full_name: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                street_address: document.getElementById('streetAddress').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postal_code: document.getElementById('postalCode').value,
                landmark: document.getElementById('landmark').value
            };
            
            // Get cart total
            const totalElement = document.querySelector('#checkoutModal [style*="font-weight: bold"] span:last-child');
            const totalAmount = parseFloat(totalElement.textContent.replace('â‚¹', ''));
            
            try {
                // Create Razorpay order
                const response = await fetch('/api/payment/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        amount: totalAmount,
                        address: addressData
                    })
                });
                
                const orderData = await response.json();
                
                if (response.ok) {
                    // Initialize Razorpay checkout
                    const options = {
                        key: orderData.key_id,
                        amount: orderData.amount * 100, // Amount in paise
                        currency: orderData.currency,
                        name: 'MedAI',
                        description: 'Medicine Order Payment',
                        order_id: orderData.order_id,
                        handler: function(response) {
                            // Payment successful
                            verifyPayment(response, addressData);
                        },
                        prefill: {
                            name: addressData.full_name,
                            email: currentUser.email,
                            contact: addressData.phone
                        },
                        theme: {
                            color: '#2563eb'
                        },
                        modal: {
                            ondismiss: function() {
                                console.log('Payment cancelled');
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                    
                } else {
                    alert('Error creating payment order: ' + orderData.error);
                }
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function verifyPayment(paymentResponse, addressData) {
            try {
                const response = await fetch('/api/payment/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        razorpay_order_id: paymentResponse.razorpay_order_id,
                        razorpay_payment_id: paymentResponse.razorpay_payment_id,
                        razorpay_signature: paymentResponse.razorpay_signature,
                        address: addressData
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Payment verified and order created
                    closeCheckoutModal();
                    showOrderSuccess(result);
                    loadCartCount(); // Reset cart count
                } else {
                    alert('Payment verification failed: ' + result.error);
                }
                
            } catch (error) {
                alert('Error verifying payment: ' + error.message);
            }
        }
        
        function showOrderSuccess(orderData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 10002;
                display: flex; justify-content: center; align-items: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; max-width: 400px; margin: 20px;">
                    <div style="font-size: 48px; color: #10b981; margin-bottom: 20px;">âœ…</div>
                    <h3 style="color: #1f2937; margin-bottom: 15px;">Order Placed Successfully!</h3>
                    <p style="color: #64748b; margin-bottom: 20px;">
                        Your order has been confirmed and payment received.
                    </p>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Order ID:</strong> ${orderData.order_id}<br>
                        <strong>Payment ID:</strong> ${orderData.payment_id}
                    </div>
                    <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                            style="background: #2563eb; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Continue Shopping
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function removeFromCart(itemId) {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/cart/remove', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ item_id: itemId })
                });
                
                if (response.ok) {
                    // Close current cart modal and reopen with updated data
                    closeCartModal();
                    toggleCart();
                    loadCartCount();
                } else {
                    alert('Error removing item from cart');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function viewOrders() {
            if (!authToken) {
                alert('Please login to view orders');
                return;
            }
            
            // Close user modal first
            closeUserModal();
            
            try {
                const response = await fetch('/api/orders', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showOrdersModal(data.orders);
                } else {
                    alert('Error loading orders');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function showOrdersModal(orders) {
            const modal = document.createElement('div');
            modal.id = 'ordersModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 10001;
                display: flex; justify-content: center; align-items: center;
                overflow-y: auto; padding: 20px;
            `;
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeOrdersModal();
                }
            };
            
            let ordersHtml = '';
            if (orders && orders.length > 0) {
                orders.forEach(order => {
                    const statusColor = {
                        'PENDING': '#f59e0b',
                        'CONFIRMED': '#2563eb',
                        'PROCESSING': '#8b5cf6',
                        'SHIPPED': '#06b6d4',
                        'DELIVERED': '#10b981',
                        'CANCELLED': '#ef4444'
                    }[order.status] || '#64748b';
                    
                    const orderDate = new Date(order.created_at).toLocaleDateString();
                    const estimatedDelivery = order.estimated_delivery ? 
                        new Date(order.estimated_delivery).toLocaleDateString() : 'TBD';
                    
                    ordersHtml += `
                        <div style="border: 1px solid #e5e7eb; padding: 16px; margin: 12px 0; border-radius: 8px; background: white; cursor: pointer;" 
                             onclick="viewOrderDetails('${order.order_id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <strong>Order #${order.order_id.substring(0, 8)}</strong>
                                    <div style="font-size: 12px; color: #64748b;">Placed on ${orderDate}</div>
                                </div>
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                    ${order.status}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 14px; color: #64748b;">
                                        Delivery to: ${order.delivery_address.city}, ${order.delivery_address.state}
                                    </div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        Expected: ${estimatedDelivery}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; font-size: 16px;">â‚¹${order.final_amount}</div>
                                    <div style="font-size: 12px; color: #64748b;">${order.payment_method}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                ordersHtml = '<div style="text-align: center; color: #64748b; padding: 40px;">No orders found</div>';
            }
            
            modal.innerHTML = `
                <div onclick="event.stopPropagation()" style="background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">ðŸ“¦ My Orders</h3>
                        <button onclick="closeOrdersModal()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #64748b;">âœ•</button>
                    </div>
                    <div style="padding: 20px;">
                        ${ordersHtml}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeOrdersModal() {
            const modal = document.getElementById('ordersModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        async function viewOrderDetails(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showOrderDetailsModal(data.order);
                } else {
                    alert('Error loading order details');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function showOrderDetailsModal(order) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 10002;
                display: flex; justify-content: center; align-items: center;
                overflow-y: auto; padding: 20px;
            `;
            
            let itemsHtml = '';
            order.items.forEach(item => {
                itemsHtml += `
                    <div style="border: 1px solid #e5e7eb; padding: 12px; margin: 8px 0; border-radius: 6px; background: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.medicine_name}</strong>
                                ${item.brand_name ? `<br><small style="color: #64748b;">${item.brand_name}</small>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div>â‚¹${item.unit_price} Ã— ${item.quantity}</div>
                                <div style="font-weight: bold;">â‚¹${item.total_price}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            let statusHtml = '';
            order.status_history.forEach(status => {
                const statusDate = new Date(status.created_at).toLocaleString();
                statusHtml += `
                    <div style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                        <div style="font-weight: 600;">${status.status}</div>
                        <div style="font-size: 12px; color: #64748b;">${statusDate}</div>
                        ${status.notes ? `<div style="font-size: 14px; color: #374151;">${status.notes}</div>` : ''}
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">ðŸ“¦ Order Details</h3>
                        <button onclick="document.body.removeChild(this.closest('div').parentElement)" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #64748b;">âœ•</button>
                    </div>
                    <div style="padding: 20px;">
                        <!-- Order Info -->
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div><strong>Order ID:</strong> ${order.order_id}</div>
                            <div><strong>Status:</strong> ${order.status}</div>
                            <div><strong>Payment:</strong> ${order.payment_method} (${order.payment_status})</div>
                            <div><strong>Order Date:</strong> ${new Date(order.created_at).toLocaleString()}</div>
                            ${order.estimated_delivery ? `<div><strong>Expected Delivery:</strong> ${new Date(order.estimated_delivery).toLocaleDateString()}</div>` : ''}
                        </div>
                        
                        <!-- Items -->
                        <h4>Items Ordered:</h4>
                        ${itemsHtml}
                        
                        <!-- Total -->
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Subtotal:</span>
                                <span>â‚¹${order.total_amount}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Delivery Fee:</span>
                                <span>â‚¹${order.delivery_fee}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
                                <span>Total:</span>
                                <span>â‚¹${order.final_amount}</span>
                            </div>
                        </div>
                        
                        <!-- Delivery Address -->
                        <div style="margin-top: 20px;">
                            <h4>Delivery Address:</h4>
                            <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                                <div><strong>${order.delivery_address.full_name}</strong></div>
                                <div>${order.delivery_address.phone}</div>
                                <div>${order.delivery_address.street_address}</div>
                                <div>${order.delivery_address.city}, ${order.delivery_address.state} - ${order.delivery_address.postal_code}</div>
                                ${order.delivery_address.landmark ? `<div>Landmark: ${order.delivery_address.landmark}</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- Status History -->
                        <div style="margin-top: 20px;">
                            <h4>Order Tracking:</h4>
                            <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                                ${statusHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function viewProfile() {
            alert('Profile editing coming soon!');
        }

        // Add to Cart Functions
        async function addToCart(medicineName, price, storeName, stock, buttonElement) {
            // Check if user is logged in
            if (!authToken || !currentUser) {
                alert('Please login to add items to cart');
                toggleUserModal();
                return;
            }
            
            // Get button element if not passed
            if (!buttonElement) {
                buttonElement = event.target;
            }
            
            try {
                // Show loading state
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                
                // Add to cart
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        medicine_name: medicineName,
                        store_name: storeName,
                        quantity: 1,
                        unit_price: price
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Success - update cart count and show feedback
                    loadCartCount();
                    showCartNotification(`âœ… ${medicineName} added to cart!`);
                    
                    // Reset button
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="fas fa-check"></i> Added';
                    buttonElement.style.background = '#10b981';
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        buttonElement.innerHTML = '<i class="fas fa-cart-plus"></i> Add to Cart';
                        buttonElement.style.background = '#2563eb';
                    }, 2000);
                    
                } else {
                    throw new Error(data.error || 'Failed to add to cart');
                }
                
            } catch (error) {
                console.error('Add to cart error:', error);
                alert('Error adding to cart: ' + error.message);
                
                // Reset button
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<i class="fas fa-cart-plus"></i> Add to Cart';
            }
        }
        
        function showCartNotification(message) {
            // Create notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10001;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Voice input functionality
        let recognition = null;
        let isListening = false;
        let silenceTimer = null;

        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    console.log('ðŸŽ¤ Voice recognition started');
                    isListening = true;
                    updateVoiceButton();
                };
                
                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Show live transcription in input field
                    const input = document.getElementById('messageInput');
                    input.value = finalTranscript + interimTranscript;
                    
                    // Auto-send after 2 seconds of silence if we have final text
                    if (finalTranscript.trim()) {
                        clearTimeout(silenceTimer);
                        silenceTimer = setTimeout(() => {
                            if (finalTranscript.trim()) {
                                stopVoiceInput();
                                sendMessage('voice');
                            }
                        }, 2000);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('ðŸŽ¤ Voice recognition error:', event.error);
                    stopVoiceInput();
                };
                
                recognition.onend = function() {
                    console.log('ðŸŽ¤ Voice recognition ended');
                    isListening = false;
                    updateVoiceButton();
                };
                
                return true;
            }
            return false;
        }

        function toggleVoiceInput() {
            if (!recognition) {
                if (!initVoiceRecognition()) {
                    alert('Voice input is not supported in this browser. Please use Chrome, Edge, or Safari.');
                    return;
                }
            }
            
            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            const input = document.getElementById('messageInput');
            input.value = '';
            input.placeholder = 'Listening... Speak now';
            
            recognition.start();
        }

        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
            }
            clearTimeout(silenceTimer);
            
            const input = document.getElementById('messageInput');
            input.placeholder = 'Ask about medicines, stores, or health...';
        }

        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceIcon = document.getElementById('voiceIcon');
            
            if (isListening) {
                voiceBtn.classList.add('listening');
                voiceIcon.className = 'fas fa-stop';
                voiceBtn.title = 'Stop listening';
            } else {
                voiceBtn.classList.remove('listening');
                voiceIcon.className = 'fas fa-microphone';
                voiceBtn.title = 'Start voice input';
            }
        }

        // Text-to-Speech functionality
        let speechSynthesis = window.speechSynthesis;
        let currentSpeech = null;

        function speakText(text) {
            // Stop any current speech
            if (currentSpeech) {
                speechSynthesis.cancel();
            }

            // Clean text for better speech (remove markdown, special chars)
            const cleanText = text
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markdown
                .replace(/\*(.*?)\*/g, '$1')     // Remove italic markdown
                .replace(/`(.*?)`/g, '$1')       // Remove code markdown
                .replace(/#{1,6}\s/g, '')        // Remove headers
                .replace(/[ðŸ“ðŸ¥ðŸ’ŠðŸ”âš¡]/g, '')      // Remove emojis
                .trim();

            if (cleanText && 'speechSynthesis' in window) {
                currentSpeech = new SpeechSynthesisUtterance(cleanText);
                
                // Configure voice settings
                currentSpeech.rate = 0.9;        // Slightly slower for clarity
                currentSpeech.pitch = 1.0;       // Normal pitch
                currentSpeech.volume = 0.8;      // Slightly quieter
                
                // Try to use a more natural voice
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.name.includes('Microsoft') ||
                    voice.lang.startsWith('en')
                );
                if (preferredVoice) {
                    currentSpeech.voice = preferredVoice;
                }

                currentSpeech.onstart = function() {
                    console.log('ðŸ”Š Started speaking AI response');
                };

                currentSpeech.onend = function() {
                    console.log('ðŸ”Š Finished speaking AI response');
                    currentSpeech = null;
                };

                currentSpeech.onerror = function(event) {
                    console.error('ðŸ”Š Speech synthesis error:', event.error);
                    currentSpeech = null;
                };

                // Start speaking
                speechSynthesis.speak(currentSpeech);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                currentSpeech = null;
            }
        }

        // Production-ready sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            const appContainer = document.querySelector('.app-container');
            const isCollapsed = sidebar.classList.contains('collapsed');
            
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                appContainer.classList.remove('sidebar-collapsed');
                expandBtn.style.display = 'none';
                localStorage.setItem('sidebarCollapsed', 'false');
            } else {
                sidebar.classList.add('collapsed');
                appContainer.classList.add('sidebar-collapsed');
                expandBtn.style.display = 'block';
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        // Initialize sidebar state
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const expandBtn = document.getElementById('expandBtn');
            const appContainer = document.querySelector('.app-container');
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            if (isCollapsed) {
                sidebar.classList.add('collapsed');
                appContainer.classList.add('sidebar-collapsed');
                expandBtn.style.display = 'block';
            }
        }
        
        // Show medicine search popup
        function showMedicineSearch() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            `;
            
            popup.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1e293b;">ðŸ’Š Find Medicines</h2>
                        <button onclick="document.body.removeChild(this.closest('.popup'))" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">âœ•</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Search by Medicine Name:</label>
                        <input type="text" id="medicineNameInput" placeholder="Enter medicine names (e.g., dolo, crocin, paracetamol)..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <span style="color: #64748b; font-weight: 600;">OR</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Upload Prescription:</label>
                        <input type="file" id="prescriptionUpload" accept="image/*" style="display: none;" onchange="handlePrescriptionUpload(event)">
                        <button onclick="document.getElementById('prescriptionUpload').click()" style="width: 100%; padding: 15px; border: 2px dashed #2563eb; background: #f8fafc; color: #2563eb; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ðŸ“· Upload Prescription Image
                        </button>
                    </div>
                    
                    <div id="extractedMedicines" style="display: none; margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Extracted Medicines:</label>
                        <div id="medicinesList" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; background: #f8fafc;"></div>
                    </div>
                    
                    <button onclick="searchMedicines()" style="width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ðŸ” Search Medicines
                    </button>
                    
                    <div id="searchResults" style="margin-top: 20px;"></div>
                </div>
            `;
            
            popup.className = 'popup';
            document.body.appendChild(popup);
            
            // Close popup when clicking outside
            popup.addEventListener('click', function(event) {
                if (event.target === popup) {
                    document.body.removeChild(popup);
                }
            });
            
            // Add global Enter key support
            popup.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    const extractedSection = document.getElementById('extractedMedicines');
                    const hasExtractedMeds = extractedSection && extractedSection.style.display !== 'none';
                    const textInput = document.getElementById('medicineNameInput').value.trim();
                    
                    // If there are extracted medicines OR text input, search
                    if (hasExtractedMeds || textInput) {
                        event.preventDefault();
                        event.stopPropagation();
                        searchMedicines();
                    }
                }
            });
        }
        
        // Handle prescription upload
        function handlePrescriptionUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Show loading
                    document.getElementById('extractedMedicines').style.display = 'block';
                    document.getElementById('medicinesList').innerHTML = '<div style="text-align: center; color: #64748b;">ðŸ” Analyzing prescription...</div>';
                    
                    // Send to backend for analysis
                    socket.emit('analyze_prescription', {
                        image: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Search medicines function
        function searchMedicines() {
            const medicineNameInput = document.getElementById('medicineNameInput').value.trim();
            const extractedMeds = document.querySelectorAll('input.medicine-item:checked');
            
            console.log('ðŸ” DEBUG - Text input:', medicineNameInput);
            console.log('ðŸ” DEBUG - Extracted checkboxes found:', extractedMeds.length);
            extractedMeds.forEach((med, i) => console.log(`ðŸ” DEBUG - Checkbox ${i}:`, med.value));
            
            let medicines = [];
            
            // Split comma-separated medicine names
            if (medicineNameInput) {
                const splitMedicines = medicineNameInput.split(',').map(name => name.trim()).filter(name => name.length > 0);
                medicines.push(...splitMedicines);
            }
            
            // Add extracted medicines from prescription
            extractedMeds.forEach(med => medicines.push(med.value));
            
            console.log('ðŸ” DEBUG - Final medicines array:', medicines);
            
            if (medicines.length === 0) {
                alert('Please enter medicine name(s) or upload prescription');
                return;
            }
            
            // Disable search button during loading
            const searchButton = document.querySelector('button[onclick="searchMedicines()"]');
            if (searchButton) {
                searchButton.disabled = true;
                searchButton.style.opacity = '0.6';
                searchButton.style.cursor = 'not-allowed';
                searchButton.innerHTML = 'â³ Searching...';
            }
            
            // Debug: Show what we're searching for
            console.log('ðŸ” Searching for medicines:', medicines);
            console.log('ðŸ” Total medicines to search:', medicines.length);
            
            // Show beautiful loading animation
            document.getElementById('searchResults').innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--primary-blue);">
                    <div style="display: inline-block; position: relative;">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 15px; font-weight: 600; font-size: 16px;">
                            ðŸ” Searching Medicines...
                        </div>
                        <div style="margin-top: 5px; font-size: 14px; color: var(--gray-text);">
                            Finding best stores and availability
                        </div>
                    </div>
                </div>
            `;
            
            // Send search request with user location
            socket.emit('search_medicines', {
                medicines: medicines,
                location: userLocation || {latitude: 18.566039, longitude: 73.766370}
            });
            
            // Debug: Confirm request sent
            console.log('ðŸ“¡ Search request sent to backend with medicines:', medicines);
            console.log('ðŸ“¡ User location:', userLocation);
        }
        
        // Store Locator popup functions
        function showStoreLocator() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    showStorePopup(lat, lon);
                }, (error) => {
                    alert('Please enable location access to find nearby stores');
                });
            } else {
                alert('Geolocation not supported by this browser');
            }
        }
        
        function showStorePopup(lat, lon) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            `;
            popup.id = 'storePopup';
            
            popup.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #1e293b;">ðŸ—ºï¸ Store Locator</h2>
                        <button onclick="closeStorePopup()" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">âœ•</button>
                    </div>
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 10px 0; height: 300px;">
                        <div id="storeMapContainer" style="height: 100%; background: #e5e7eb; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                            ðŸ—ºï¸ Loading map...
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Load Folium map from backend
            setTimeout(() => {
                const mapContainer = document.getElementById('storeMapContainer');
                console.log('ðŸ—ºï¸ Looking for storeMapContainer:', mapContainer);
                if (mapContainer) {
                    console.log('ðŸ—ºï¸ Loading iframe map for coordinates:', lat, lon);
                    mapContainer.innerHTML = `
                        <iframe src="/api/map/${lat}/${lon}" style="width: 100%; height: 100%; border: none; border-radius: 4px;"></iframe>
                    `;
                } else {
                    console.error('âŒ storeMapContainer not found');
                }
            }, 500); // Increased timeout from 100ms to 500ms
        }
        
        function closeStorePopup() {
            const popup = document.getElementById('storePopup');
            if (popup) {
                document.body.removeChild(popup);
            }
        }

        // Chat session management
        let currentThreadId = null;
        let userLocation = null;

        // Load chat threads from API
        function loadChatThreads() {
            fetch('/api/threads')
                .then(response => {
                    if (!response.ok) throw new Error('API not available');
                    return response.json();
                })
                .then(threads => {
                    const threadsList = document.getElementById('threadsList');
                    if (!threadsList) return;
                    
                    threadsList.innerHTML = '';
                    
                    if (threads.length === 0) {
                        threadsList.innerHTML = '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">No previous chats</div>';
                        return;
                    }
                    
                    threads.forEach(thread => {
                        const threadDiv = document.createElement('div');
                        threadDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;';
                        
                        const isCurrent = thread.id === currentThreadId;
                        if (isCurrent) {
                            threadDiv.style.background = '#dbeafe';
                        }
                        
                        threadDiv.innerHTML = `
                            <div style="flex: 1; font-size: 13px; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${isCurrent ? 'ðŸŸ¢ ' : ''}${thread.title}
                            </div>
                            <button onclick="deleteThread('${thread.id}', event)" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px; margin-left: 8px;">
                                <i class="fas fa-trash" style="font-size: 10px;"></i>
                            </button>
                        `;
                        
                        threadDiv.onclick = (e) => {
                            if (e.target.closest('button')) return;
                            loadThread(thread.id);
                        };
                        
                        threadDiv.onmouseenter = () => {
                            if (!isCurrent) threadDiv.style.background = '#f3f4f6';
                        };
                        threadDiv.onmouseleave = () => {
                            if (!isCurrent) threadDiv.style.background = 'transparent';
                        };
                        
                        threadsList.appendChild(threadDiv);
                    });
                })
                .catch(error => {
                    console.log('Chat threads not available:', error);
                    const threadsList = document.getElementById('threadsList');
                    if (threadsList) {
                        threadsList.innerHTML = '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">Chat history unavailable</div>';
                    }
                });
        }

        // Load specific thread (simplified)
        function loadThread(threadId) {
            console.log('Loading thread:', threadId);
            currentThreadId = threadId;
            
            // Clear current messages
            document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">Loading chat...</div>';
            
            // Hide welcome section
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // Try to load messages from API
            fetch(`/api/thread/${threadId}/messages`)
                .then(response => {
                    if (!response.ok) throw new Error('Thread not found');
                    return response.json();
                })
                .then(messages => {
                    // Clear loading message
                    document.getElementById('chatMessages').innerHTML = '';
                    
                    // Add messages
                    messages.forEach(msg => {
                        addMessageToChat(msg.role, msg.content);
                    });
                    
                    // Update thread list to show current
                    loadChatThreads();
                })
                .catch(error => {
                    console.log('Could not load thread messages:', error);
                    // Show error but don't break
                    document.getElementById('chatMessages').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Could not load chat history</div>';
                });
        }

        // Delete thread
        function deleteThread(threadId, event) {
            event.stopPropagation();
            if (confirm('Delete this chat?')) {
                fetch(`/api/thread/${threadId}/delete`, { method: 'DELETE' })
                    .then(() => {
                        if (threadId === currentThreadId) {
                            newChat();
                        }
                        loadChatThreads();
                    })
                    .catch(error => console.error('Error deleting thread:', error));
            }
        }

        // New chat function (simplified)
        function newChat() {
            // Generate new thread ID
            currentThreadId = 'thread_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Clear all messages first
            document.getElementById('chatMessages').innerHTML = '';
            
            // Create fresh welcome section with action buttons
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-section" id="welcomeSection">
                    <h2 class="welcome-title">Welcome to MedAI</h2>
                    <p class="welcome-subtitle">Your intelligent medical assistant for medicines and healthcare</p>
                    
                    <div class="action-cards">
                        <button class="action-card" onclick="showMedicineSearch()">
                            <i class="fas fa-pills"></i>
                            <h3>Find Medicines</h3>
                            <p>Search for medicines and check availability</p>
                        </button>
                        
                        <button class="action-card" onclick="showStoreLocator()">
                            <i class="fas fa-map-marker-alt"></i>
                            <h3>Store Locator</h3>
                            <p>Find nearest pharmacies and medical stores</p>
                        </button>
                    </div>
                </div>
            `;
            
            // Update title
            document.getElementById('chatTitle').textContent = 'Medical Assistant';
            
            // Add new thread to sidebar immediately
            addNewThreadToSidebar(currentThreadId, 'New Chat');
            
            console.log('New chat started:', currentThreadId);
        }

        // Add new thread to sidebar
        function addNewThreadToSidebar(threadId, title) {
            const threadsList = document.getElementById('threadsList');
            if (!threadsList) return;
            
            // Remove active class from all existing threads
            const existingThreads = threadsList.querySelectorAll('.thread-item');
            existingThreads.forEach(thread => {
                thread.classList.remove('active');
                const titleDiv = thread.querySelector('.thread-title');
                if (titleDiv && titleDiv.textContent.startsWith('ðŸŸ¢ ')) {
                    titleDiv.textContent = titleDiv.textContent.replace('ðŸŸ¢ ', '');
                }
            });
            
            // Create new thread element with CSS classes
            const threadDiv = document.createElement('div');
            threadDiv.className = 'thread-item active';
            
            threadDiv.innerHTML = `
                <div class="thread-title">ðŸŸ¢ ${title}</div>
                <button class="thread-delete-btn" onclick="deleteThread('${threadId}', event)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            threadDiv.onclick = (e) => {
                if (e.target.closest('button')) return;
                loadThread(threadId);
            };
            
            // Add to top of list
            threadsList.insertBefore(threadDiv, threadsList.firstChild);
        }

        // Load chat threads with new styling
        function loadChatThreads() {
            fetch('/api/threads')
                .then(response => response.json())
                .then(threads => {
                    const threadsList = document.getElementById('threadsList');
                    if (!threadsList) return;
                    
                    // Clear existing threads
                    threadsList.innerHTML = '';
                    
                    // Add each thread with new styling
                    threads.forEach(thread => {
                        const threadDiv = document.createElement('div');
                        threadDiv.className = 'thread-item';
                        
                        threadDiv.innerHTML = `
                            <div class="thread-title">${thread.title}</div>
                            <button class="thread-delete-btn" onclick="deleteThread('${thread.id}', event)">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        
                        threadDiv.onclick = (e) => {
                            if (e.target.closest('button')) return;
                            loadThread(thread.id);
                        };
                        
                        threadsList.appendChild(threadDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading threads:', error);
                    const threadsList = document.getElementById('threadsList');
                    if (threadsList) {
                        threadsList.innerHTML = '<div style="color: #9ca3af; font-size: 12px; text-align: center; padding: 20px;">Chat history unavailable</div>';
                    }
                });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSidebar();
            loadChatThreads(); // Load existing threads with new styling
            newChat(); // Start with a new chat
            
            // Clear message input on page load (prevent autofill)
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = '';
                messageInput.setAttribute('readonly', true);
                // Force clear after delays to override autofill
                setTimeout(() => {
                    messageInput.value = '';
                    messageInput.removeAttribute('readonly');
                }, 500);
                setTimeout(() => {
                    messageInput.value = '';
                }, 1000);
            }
            
            // Enable thread loading with error handling
            try {
                loadChatThreads();
            } catch (error) {
                console.log('Thread loading failed, continuing without it');
            }
        });

        // Initialize socket connection
        const socket = io();
        currentThreadId = 'main-thread-' + Date.now();
        
        socket.on('connect', () => {
            console.log('âœ… Socket connected');
        });
        
        socket.on('message_received', (data) => {
            console.log('ðŸ“¨ Message received:', data);
            
            addMessageToChat(data.role, data.content, data.image);
            
            // Voice synthesis now handled conditionally by backend
            // Only voice inputs will get polly_audio_ready event
            
            // Add AI thinking loader after user message appears
            if (data.role === 'user') {
                addAIThinkingLoader();
            }
            
            // Remove AI thinking loader when assistant responds
            if (data.role === 'assistant') {
                removeAIThinkingLoader();
            }
            
            // Refresh sidebar after assistant response to show new/updated threads
            if (data.role === 'assistant') {
                setTimeout(() => {
                    try {
                        loadChatThreads();
                    } catch (error) {
                        console.log('Could not refresh threads');
                    }
                }, 1000);
            }
        });

        // Handle streaming response events
        let currentStreamingMessage = null;
        let streamingContent = '';
        let pollyAudio = null;

        socket.on('response_start', (data) => {
            console.log('ðŸ”„ Streaming response started');
            removeAIThinkingLoader();
            
            // Stop any current speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            if (pollyAudio) {
                pollyAudio.pause();
                pollyAudio = null;
            }
            
            // Create empty assistant message for streaming
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = `streaming-${data.thread_id}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content streaming-content">
                    <span class="streaming-cursor">|</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            currentStreamingMessage = messageDiv.querySelector('.message-content');
            streamingContent = '';
        });

        // Handle AWS Polly audio
        socket.on('polly_audio_ready', (data) => {
            console.log('ðŸ”Š AWS Polly audio received');
            
            try {
                // Convert base64 to audio blob
                const audioData = atob(data.audio_data);
                const audioArray = new Uint8Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    audioArray[i] = audioData.charCodeAt(i);
                }
                
                const audioBlob = new Blob([audioArray], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                pollyAudio = new Audio(audioUrl);
                pollyAudio.volume = 0.8;
                
                pollyAudio.play().then(() => {
                    console.log('ðŸ”Š AWS Polly audio started');
                }).catch(error => {
                    console.error('ðŸ”Š Audio play error:', error);
                    fallbackToBrowserTTS();
                });
                
            } catch (error) {
                console.error('ðŸ”Š Polly audio processing error:', error);
                fallbackToBrowserTTS();
            }
        });

        socket.on('response_chunk', (data) => {
            if (currentStreamingMessage) {
                streamingContent += data.chunk;
                const formattedContent = formatMessageContent(streamingContent);
                currentStreamingMessage.innerHTML = formattedContent + '<span class="streaming-cursor">|</span>';
                
                // Auto-scroll
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });

        socket.on('response_complete', (data) => {
            console.log('âœ… Streaming response completed');
            
            if (currentStreamingMessage) {
                // Remove cursor and finalize content
                const formattedContent = formatMessageContent(data.full_content);
                currentStreamingMessage.innerHTML = formattedContent;
                currentStreamingMessage.classList.remove('streaming-content');
                
                // Reset streaming state
                currentStreamingMessage = null;
                streamingContent = '';
            }
        });

        function fallbackToBrowserTTS() {
            // Only use browser TTS fallback for voice inputs
            if (currentInputMethod === 'voice' && streamingContent) {
                console.log('Using browser TTS fallback for voice input');
                const cleanText = streamingContent.replace(/<[^>]*>/g, '');
                speakText(cleanText);
            } else {
                console.log('Skipping TTS fallback - input method:', currentInputMethod);
            }
        }

        socket.on('title_updated', (data) => {
            console.log('ðŸ“ Title updated:', data);
            // Update chat title in header
            if (data.thread_id === currentThreadId) {
                document.getElementById('chatTitle').textContent = data.title;
            }
            // Refresh sidebar to show updated title
            try {
                loadChatThreads();
            } catch (error) {
                console.log('Could not refresh threads');
            }
        });
        
        socket.on('show_map', (data) => {
            console.log('ðŸ—ºï¸ Map data received:', data);
            
            // If waiting for popup map, update the popup
            if (window.waitingForPopupMap && data.stores) {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="width: 100%; height: 100%; background: #059669; color: white; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex-direction: column;">
                            <div>ðŸ“ Found ${data.stores.length} stores</div>
                            <div style="font-size: 12px; margin-top: 5px;">Map will be enhanced next</div>
                        </div>
                    `;
                }
                window.waitingForPopupMap = false;
            } else if (data.stores && data.stores.length > 0) {
                // Show inline chat map
                console.log('ðŸ—ºï¸ Adding inline map to chat');
                addInlineChatMap(data.stores, data.user_location);
            }
        });
        
        socket.on('medicine_search_result', (data) => {
            console.log('ðŸ’Š Medicine search result received:', data);
            
            // Re-enable search button
            const searchButton = document.querySelector('button[onclick="searchMedicines()"]');
            if (searchButton) {
                searchButton.disabled = false;
                searchButton.style.opacity = '1';
                searchButton.style.cursor = 'pointer';
                searchButton.innerHTML = 'ðŸ” Search Medicines';
            }
            
            const resultsDiv = document.getElementById('searchResults');
            if (!resultsDiv) return;
            
            if (data.error) {
                resultsDiv.innerHTML = `<div style="color: red; padding: 20px;">âŒ Error: ${data.error}</div>`;
                return;
            }
            
            if (data.success && data.results) {
                if (data.results.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 20px; color: #64748b;">No medicines found</div>';
                } else {
                    let html = '<div style="padding: 20px;">';
                    
                    // Add search summary if available
                    if (data.search_summary) {
                        html += `<div style="background: #f0f9ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <strong>ðŸ” Search Summary:</strong><br>
                            Searched for: ${data.search_summary.medicines_requested.join(', ')}<br>`;
                        
                        // Show LLM spelling corrections if any
                        if (data.search_summary.spelling_corrections && Object.keys(data.search_summary.spelling_corrections).length > 0) {
                            html += `<div style="background: #fef3c7; padding: 8px; border-radius: 4px; margin: 8px 0; border-left: 4px solid #f59e0b;">
                                <strong>ðŸ¤– Smart Corrections:</strong><br>`;
                            for (const [original, corrected] of Object.entries(data.search_summary.spelling_corrections)) {
                                html += `â€¢ "${original}" â†’ "${corrected}"<br>`;
                            }
                            html += `</div>`;
                        }
                        
                        html += `Found ${data.search_summary.total_stores_found} stores<br>
                            Best match: ${data.search_summary.best_match}
                        </div>`;
                    }
                    
                    html += '<h4>ðŸª Stores (Ranked by Availability):</h4>';
                    
                    data.results.forEach((store, index) => {
                        // Handle both old format (array) and new format (object)
                        if (Array.isArray(store)) {
                            // Old format compatibility
                            html += `
                                <div style="border: 1px solid #e5e7eb; padding: 15px; margin: 10px 0; border-radius: 8px;">
                                    <strong>${store[0] || 'Unknown Medicine'}</strong><br>
                                    Price: â‚¹${store[1] || 'N/A'}<br>
                                    Store: ${store[2] || 'Unknown Store'}<br>
                                    Stock: ${store[3] || 'N/A'} units
                                </div>
                            `;
                        } else {
                            // New enhanced format
                            const availabilityColor = store.availability_percentage >= 80 ? '#10b981' : 
                                                    store.availability_percentage >= 50 ? '#f59e0b' : '#ef4444';
                            
                            html += `
                                <div style="border: 1px solid #e5e7eb; padding: 15px; margin: 10px 0; border-radius: 8px; background: ${index === 0 ? '#f0f9ff' : 'white'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h5 style="margin: 0; color: #1f2937;">${store.store_name}</h5>
                                        <span style="background: ${availabilityColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                            ${store.availability_percentage}% Match
                                        </span>
                                    </div>
                                    
                                    <div style="color: #64748b; font-size: 14px; margin-bottom: 10px;">
                                        ðŸ“ ${store.distance} km away â€¢ 
                                        ðŸ“¦ ${store.medicines_available}/${store.total_medicines_requested} medicines available
                                    </div>
                                    
                                    <div style="background: #f9fafb; padding: 10px; border-radius: 6px;">
                                        <strong>Available Medicines:</strong><br>
                            `;
                            
                            store.medicines.forEach(medicine => {
                                html += `
                                    <div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            â€¢ <strong>${medicine.name}</strong> - â‚¹${medicine.price} 
                                            <span style="color: #10b981;">(${medicine.stock} in stock)</span>
                                        </div>
                                        <button class="add-to-cart-btn" onclick="addToCart('${medicine.name}', ${medicine.price}, '${store.store_name}', ${medicine.stock}, this)" 
                                                style="background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-cart-plus"></i> Add to Cart
                                        </button>
                                    </div>
                                `;
                            });
                            
                            html += `
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                }
            }
        });
        
        socket.on('prescription_analysis_result', (data) => {
            console.log('ðŸ“‹ Prescription analysis result received:', data);
            console.log('ðŸ“‹ Data structure:', JSON.stringify(data, null, 2));
            console.log('ðŸ“‹ Medicines found:', data.data ? data.data.medicines : 'No data.medicines');
            
            const extractedSection = document.getElementById('extractedMedicines');
            const medicinesList = document.getElementById('medicinesList');
            
            if (!extractedSection || !medicinesList) {
                console.log('ðŸ“‹ ERROR: Could not find extractedMedicines or medicinesList elements');
                return;
            }
            
            if (data.error) {
                medicinesList.innerHTML = `<div style="color: red;">âŒ Error: ${data.error}</div>`;
                extractedSection.style.display = 'block';
                return;
            }
            
            if (data.success && data.data) {
                const medicines = data.data.medicines || [];
                console.log('ðŸ“‹ Processing medicines array:', medicines);
                
                if (medicines.length === 0) {
                    medicinesList.innerHTML = '<div style="color: #64748b;">No medicines detected in image</div>';
                } else {
                    let html = '<div>Found medicines:</div>';
                    medicines.forEach((medicine, index) => {
                        html += `
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" class="medicine-item" value="${medicine}" checked style="margin-right: 8px;">
                                ${medicine}
                            </label>
                        `;
                    });
                    html += `<button onclick="removePrescription()" style="margin-top: 10px; padding: 8px 15px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">ðŸ—‘ï¸ Remove Prescription</button>`;
                    medicinesList.innerHTML = html;
                    
                    // Add Enter key support to extracted medicine checkboxes
                    const checkboxes = document.querySelectorAll('input.medicine-item');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('keypress', function(event) {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                searchMedicines();
                            }
                        });
                    });
                    
                    // Add Enter key support to extracted medicines section
                    const extractedSection = document.getElementById('extractedMedicines');
                    if (extractedSection) {
                        extractedSection.addEventListener('keypress', function(event) {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                searchMedicines();
                            }
                        });
                        
                        // Auto-focus the section so Enter works immediately
                        extractedSection.setAttribute('tabindex', '0');
                        extractedSection.focus();
                    }
                }
                
                extractedSection.style.display = 'block';
                console.log('ðŸ“‹ Extracted medicines section should now be visible');
            }
        });
        
        // Add AI thinking loader
        function addAIThinkingLoader() {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'ai-thinking-loader';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content" style="background: var(--gray-light); color: var(--gray-text);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span style="font-style: italic;">AI is thinking...</span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Remove AI thinking loader
        function removeAIThinkingLoader() {
            const loader = document.getElementById('ai-thinking-loader');
            if (loader) {
                loader.remove();
            }
        }

        // Add message to chat interface
        function addMessageToChat(role, content, imageData = null) {
            const messagesContainer = document.getElementById('chatMessages');
            
            // Hide welcome section when first message is added
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // If there's both image and text, create two separate messages
            if (imageData && content && content.trim() && content !== "ðŸ“· Uploaded prescription image") {
                // First add image message (no avatar)
                const imageDiv = document.createElement('div');
                imageDiv.className = `message ${role}`;
                
                imageDiv.innerHTML = `
                    <div class="message-content" style="margin-left: 0;">
                        <img src="${imageData}" alt="Uploaded prescription" style="max-width: 300px; max-height: 300px; border-radius: 4px; margin: 5px 0; display: block;">
                    </div>
                `;
                messagesContainer.appendChild(imageDiv);
                
                // Then add text message (with avatar)
                const textDiv = document.createElement('div');
                textDiv.className = `message ${role}`;
                
                const avatar = role === 'user' ? 
                    '<i class="fas fa-user"></i>' : 
                    '<i class="fas fa-robot"></i>';
                
                textDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        ${formatMessageContent(content)}
                    </div>
                `;
                messagesContainer.appendChild(textDiv);
            } else {
                // Single message (text only or image only)
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatar = role === 'user' ? 
                    '<i class="fas fa-user"></i>' : 
                    '<i class="fas fa-robot"></i>';
                
                const formattedContent = formatMessageContent(content, imageData);
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        ${formattedContent}
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessageContent(content, imageData = null) {
            let formattedText = '';
            
            // Format text content if it exists
            if (content && content.trim()) {
                // Remove context messages from display (but keep in conversation history)
                let displayContent = content.replace(/\[Context:.*?\]/g, '').trim();
                
                // Convert markdown-like formatting to HTML
                formattedText = displayContent
                    // Bold text: **text** -> <strong>text</strong>
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    // Italic text: *text* -> <em>text</em>
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    // Code: `text` -> <code>text</code>
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    // Line breaks: \n -> <br>
                    .replace(/\n/g, '<br>')
                    // Headers: ### text -> <h3>text</h3>
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    // Lists: - item -> <li>item</li>
                    .replace(/^- (.*$)/gm, '<li>$1</li>')
                    // Wrap consecutive <li> items in <ul>
                    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                    // Fix nested ul tags
                    .replace(/<\/ul>\s*<ul>/g, '');
            }
            
            // For single image message
            if (imageData && !formattedText) {
                return `<img src="${imageData}" alt="Uploaded prescription" style="max-width: 300px; max-height: 300px; border-radius: 4px; margin: 5px 0; display: block;">`;
            }
            
            return formattedText;

            return formatted;
        }
        
        // Send quick message from action cards
        function sendQuickMessage(message) {
            console.log('ðŸŽ¯ Sending message:', message);
            
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = message;
            }
            
            socket.emit('send_message', {
                thread_id: currentThreadId,
                message: message,
                location: null
            });
        }
        
        // Handle manual message input
        // Track current input method for voice control
        let currentInputMethod = 'text';
        
        function sendMessage(inputMethod = 'text') {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !selectedImage) return;
            
            // Store current input method for voice control
            currentInputMethod = inputMethod;
            
            console.log('Sending message with thread ID:', currentThreadId, 'Input method:', inputMethod);
            
            socket.emit('send_message', {
                thread_id: currentThreadId,
                message: message,
                image: selectedImage,
                location: userLocation,
                input_method: selectedImage ? 'image' : inputMethod
            });
            
            input.value = '';
            
            // Clear selected image after sending
            if (selectedImage) {
                removeImage();
            }
            
            // Hide welcome section
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
        }
        
        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Handle image upload
        // Remove prescription function
        function removePrescription() {
            const extractedSection = document.getElementById('extractedMedicines');
            const prescriptionUpload = document.getElementById('prescriptionUpload');
            
            if (extractedSection) {
                extractedSection.style.display = 'none';
            }
            if (prescriptionUpload) {
                prescriptionUpload.value = '';
            }
        }
        
        let selectedImage = null;
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                currentInputMethod = 'image';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImage = e.target.result;
                    showImagePreview(file.name);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function showImagePreview(fileName) {
            const inputContainer = document.querySelector('.input-container');
            
            // Remove existing preview
            const existingPreview = document.getElementById('imagePreview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Add image preview above input
            const previewHTML = `
                <div id="imagePreview" style="display: flex; align-items: center; padding: 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px;">
                    <img src="${selectedImage}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; margin-right: 12px;">
                    <span style="flex: 1; color: #64748b; font-size: 14px;">ðŸ“„ ${fileName}</span>
                    <button onclick="removeImage()" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">&times;</button>
                </div>
            `;
            inputContainer.insertAdjacentHTML('beforebegin', previewHTML);
            
            // Focus on message input
            document.getElementById('messageInput').focus();
        }
        
        function removeImage() {
            selectedImage = null;
            const preview = document.getElementById('imagePreview');
            if (preview) {
                preview.remove();
            }
            document.getElementById('imageInput').value = '';
        }
        
        // Add inline chat map function
        function addInlineChatMap(stores, userLocation) {
            if (!stores || stores.length === 0) return;
            
            console.log('ðŸ—ºï¸ Creating inline chat map');
            
            // Use default location if userLocation is null
            const location = userLocation || {latitude: 18.558091, longitude: 73.793439};
            
            // Create inline map HTML
            const mapHtml = `
                <div class="inline-map-container" style="margin: 15px 0 !important; border: 2px solid #059669 !important; border-radius: 8px; overflow: hidden; background: white !important; display: block !important; width: 100% !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;">
                    <div style="background: #f8fafc !important; padding: 12px !important; border-bottom: 2px solid #059669 !important; font-size: 16px !important; font-weight: 600 !important; color: #1f2937 !important;">
                        ðŸ“ ${stores.length} Store${stores.length > 1 ? 's' : ''} Found Nearby
                    </div>
                    <iframe src="/api/map/${location.latitude}/${location.longitude}" 
                            style="width: 100% !important; height: 300px !important; border: none !important; display: block !important;">
                    </iframe>
                    <div style="padding: 12px !important; background: #f8fafc !important; text-align: center !important; font-size: 14px !important; color: #6b7280 !important;">
                        Interactive map â€¢ <span onclick="document.querySelector('.store-locator-btn').click()" style="color: #059669 !important; cursor: pointer !important; text-decoration: underline !important;">View Full Screen</span>
                    </div>
                </div>
            `;
            
            // Add map to the latest assistant message with delay
            setTimeout(() => {
                const messages = document.querySelectorAll('.message.assistant');
                const latestMessage = messages[messages.length - 1];
                console.log('ðŸŽ¯ Found', messages.length, 'assistant messages, targeting latest');
                
                if (latestMessage) {
                    const messageContent = latestMessage.querySelector('.message-content');
                    if (messageContent) {
                        console.log('âœ… Adding map to message content');
                        messageContent.innerHTML += mapHtml;
                        
                        // Verify it was added
                        setTimeout(() => {
                            const mapCheck = messageContent.querySelector('.inline-map-container');
                            if (mapCheck) {
                                console.log('âœ… Map HTML confirmed in DOM');
                            } else {
                                console.log('âŒ Map HTML not found in DOM - might be overwritten');
                            }
                        }, 100);
                    } else {
                        console.log('âŒ No message-content found');
                    }
                } else {
                    console.log('âŒ No assistant messages found');
                }
            }, 200);
        }
        
        // End of JavaScript
    </script>

    <!-- Authentication Modal -->
    <div class="modal-overlay" id="userModal" onclick="closeUserModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Welcome to MedAI</h3>
                <button class="modal-close" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Auth Tabs -->
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="showAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="showAuthTab('register')">Register</button>
                </div>
                
                <!-- Login Form -->
                <div class="auth-form" id="loginForm">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                    <button class="auth-btn" onclick="login()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
                
                <!-- Register Form -->
                <div class="auth-form hidden" id="registerForm">
                    <input type="text" id="registerName" placeholder="Full Name" required>
                    <input type="email" id="registerEmail" placeholder="Email" required>
                    <input type="tel" id="registerPhone" placeholder="Phone (optional)">
                    <input type="password" id="registerPassword" placeholder="Password" required>
                    <button class="auth-btn" onclick="register()">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                </div>
                
                <!-- User Profile (when logged in) -->
                <div class="user-profile hidden" id="userProfile">
                    <div class="profile-info">
                        <div class="profile-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="profile-details">
                            <h4 id="profileName">User Name</h4>
                            <p id="profileEmail"></p>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button class="profile-btn" onclick="viewOrders()">
                            <i class="fas fa-list"></i> My Orders
                        </button>
                        <button class="profile-btn" onclick="viewProfile()">
                            <i class="fas fa-user-edit"></i> Edit Profile
                        </button>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Overlay and Container -->
    <div id="mapOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="mapContainer" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 70%; background: white; border-radius: 8px; overflow: hidden;">
            <div style="position: absolute; top: 10px; right: 10px; z-index: 1001;">
                <button onclick="document.getElementById('mapOverlay').style.display='none'" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div id="map" style="width: 100%; height: 100%;"></div>
        </div>
    </div>

</body>
</html>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
