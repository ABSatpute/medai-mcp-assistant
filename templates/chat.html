<!DOCTYPE html>
<html>
<head>
    <title>MedAI - Medical Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100vh; }
        .chat-container { height: 100vh; background: white; }
        .messages { height: 70vh; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        .message { margin: 10px 0; }
        .user { text-align: right; }
        .user .msg { background: #007bff; color: white; padding: 10px; border-radius: 15px; display: inline-block; max-width: 70%; }
        .assistant .msg { background: white; border: 1px solid #ddd; padding: 10px; border-radius: 15px; display: inline-block; max-width: 70%; }
        .input-area { padding: 20px; border-top: 1px solid #ddd; }
        .sidebar { background: white; height: 100vh; border-right: 1px solid #ddd; padding: 20px; }
        .thread { padding: 10px; margin: 5px 0; border-radius: 8px; cursor: pointer; }
        .thread:hover { background: #f0f0f0; }
        .thread.active { background: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-3 sidebar">
                <h4>üè• MedAI</h4>
                <button class="btn btn-primary w-100 mb-3" onclick="newChat()">New Chat</button>
                <div id="threads"></div>
            </div>
            <div class="col-9 chat-container">
                <div class="messages" id="messages">
                    <div class="text-center mt-5">
                        <h3>Welcome to MedAI</h3>
                        <p>Your intelligent medical assistant</p>
                    </div>
                </div>
                <div class="input-area">
                    <div class="input-group">
                        <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImage(event)">
                        <button class="btn btn-outline-secondary" onclick="document.getElementById('imageInput').click()">üì∑</button>
                        <input type="text" class="form-control" id="messageInput" placeholder="Ask about medicines..." onkeypress="handleEnter(event)">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                    <div id="imagePreview" style="display:none; margin-top:10px;">
                        <img id="previewImg" style="max-width:200px; border-radius:8px;">
                        <button class="btn btn-sm btn-danger ms-2" onclick="removeImage()">Remove</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentThread = null;
        let currentImage = null;

        function newChat() {
            currentThread = null;
            document.getElementById('messages').innerHTML = '<div class="text-center mt-5"><h3>Welcome to MedAI</h3><p>Your intelligent medical assistant</p></div>';
            document.querySelectorAll('.thread').forEach(t => t.classList.remove('active'));
        }

        function addMessage(role, content, hasImage = false, imageSrc = null) {
            const messages = document.getElementById('messages');
            if (messages.innerHTML.includes('Welcome to MedAI')) {
                messages.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            let imageHtml = '';
            if (hasImage && imageSrc) {
                imageHtml = `<div class="message-image mb-2"><img src="${imageSrc}" style="max-width: 200px; border-radius: 8px; border: 1px solid #ddd;"></div>`;
            }
            
            div.innerHTML = `<div class="msg">${imageHtml}${content}</div>`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !currentImage) return;
            
            addMessage('user', message || 'üì∑ Image uploaded');
            input.value = '';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        thread_id: currentThread,
                        message: message,
                        image: currentImage
                    })
                });
                
                const data = await response.json();
                currentThread = data.thread_id;
                addMessage('assistant', data.response);
                removeImage();
                loadThreads();
                
            } catch (error) {
                addMessage('assistant', 'Sorry, something went wrong.');
            }
        }

        function handleEnter(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function handleImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            currentImage = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageInput').value = '';
        }

        async function loadThreads() {
            try {
                const response = await fetch('/api/threads');
                const threads = await response.json();
                
                const container = document.getElementById('threads');
                container.innerHTML = '';
                
                threads.forEach(thread => {
                    const div = document.createElement('div');
                    div.className = 'thread';
                    div.textContent = thread.title;
                    div.onclick = () => loadThread(thread.id);
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load threads');
            }
        }

        async function loadThread(threadId) {
            try {
                const response = await fetch(`/api/thread/${threadId}`);
                const messages = await response.json();
                
                currentThread = threadId;
                document.getElementById('messages').innerHTML = '';
                
                messages.forEach(msg => {
                    addMessage(msg.role, msg.content);
                });
                
                document.querySelectorAll('.thread').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                
            } catch (error) {
                console.error('Failed to load thread');
            }
        }

        // Load threads on page load
        loadThreads();
    </script>
</body>
</html>
